<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KhemBank - Chemistry Question Bank System</title>
    
    <!-- MathJax for mathematical equations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js"></script>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* Import distinctive fonts */
        @import url('https://fonts.googleapis.com/css2?family=Archivo+Black&family=DM+Sans:wght@400;500;700&family=JetBrains+Mono:wght@400;600&display=swap');
        
        :root {
            /* Chemistry-inspired color palette */
            --primary: #00D9FF;
            --primary-dark: #0099CC;
            --secondary: #FF6B35;
            --accent: #FFE66D;
            --success: #06FFA5;
            --danger: #FF006E;
            --dark: #0A0E27;
            --mid-dark: #1A1F3A;
            --light: #F0F4F8;
            --white: #FFFFFF;
            
            /* Shadows and effects */
            --shadow-sm: 0 2px 8px rgba(0, 217, 255, 0.15);
            --shadow-md: 0 4px 16px rgba(0, 217, 255, 0.2);
            --shadow-lg: 0 8px 32px rgba(0, 217, 255, 0.25);
            --glow: 0 0 20px rgba(0, 217, 255, 0.5);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--dark);
            color: var(--light);
            overflow-x: hidden;
            position: relative;
        }
        
        /* Animated background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(0, 217, 255, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(255, 107, 53, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(255, 230, 109, 0.05) 0%, transparent 70%);
            z-index: -1;
            animation: float 20s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.1) rotate(5deg); }
        }
        
        /* Header */
        header {
            background: rgba(26, 31, 58, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid var(--primary);
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-family: 'Archivo Black', sans-serif;
            font-size: 2rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -1px;
            text-transform: uppercase;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            opacity: 0.8;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--danger);
            animation: pulse 2s infinite;
        }
        
        .status-dot.connected {
            background: var(--success);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .nav-buttons {
            display: flex;
            gap: 1rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-family: 'DM Sans', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--dark);
            box-shadow: var(--shadow-md);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--glow);
        }
        
        .btn-secondary {
            background: transparent;
            color: var(--light);
            border: 2px solid var(--primary);
        }
        
        .btn-secondary:hover {
            background: var(--primary);
            color: var(--dark);
        }
        
        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }
        
        .btn-success {
            background: var(--success);
            color: var(--dark);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Main container */
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        
        /* View sections */
        .view {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .view.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Welcome screen */
        .welcome-screen {
            text-align: center;
            padding: 4rem 2rem;
        }
        
        .welcome-title {
            font-family: 'Archivo Black', sans-serif;
            font-size: 4rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
        }
        
        .welcome-subtitle {
            font-size: 1.5rem;
            color: var(--light);
            margin-bottom: 1rem;
            opacity: 0.9;
        }
        
        .welcome-info {
            font-size: 1rem;
            color: var(--accent);
            margin-bottom: 3rem;
            opacity: 0.8;
        }
        
        .portal-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-top: 3rem;
        }
        
        .portal-card {
            background: rgba(26, 31, 58, 0.6);
            backdrop-filter: blur(10px);
            border: 2px solid var(--primary);
            border-radius: 16px;
            padding: 3rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .portal-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .portal-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--glow);
        }
        
        .portal-card:hover::before {
            opacity: 0.1;
        }
        
        .portal-card h2 {
            position: relative;
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--primary);
        }
        
        .portal-card p {
            position: relative;
            font-size: 1.1rem;
            opacity: 0.9;
            line-height: 1.6;
        }
        
        /* Panels */
        .panel {
            background: rgba(26, 31, 58, 0.6);
            backdrop-filter: blur(10px);
            border: 2px solid var(--primary);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(0, 217, 255, 0.2);
        }
        
        .panel-header span {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--accent);
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            background: rgba(10, 14, 39, 0.8);
            border: 2px solid rgba(0, 217, 255, 0.3);
            border-radius: 8px;
            color: var(--light);
            font-family: 'DM Sans', sans-serif;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        /* Checkbox group */
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            transition: background 0.2s ease;
        }
        
        .checkbox-label:hover {
            background: rgba(0, 217, 255, 0.1);
        }
        
        .checkbox-label input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }
        
        /* Question list */
        .question-item {
            background: rgba(10, 14, 39, 0.8);
            border: 1px solid rgba(0, 217, 255, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }
        
        .question-item:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }
        
        .question-text {
            flex: 1;
            font-size: 1.1rem;
            line-height: 1.6;
        }
        
        .question-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .tag {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .tag-topic {
            background: var(--primary);
            color: var(--dark);
        }
        
        .tag-difficulty {
            background: var(--mid-dark);
            color: var(--light);
            border: 1px solid var(--accent);
        }
        
        .tag-difficulty.easy {
            border-color: var(--success);
            color: var(--success);
        }
        
        .tag-difficulty.medium {
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .tag-difficulty.hard {
            border-color: var(--danger);
            color: var(--danger);
        }
        
        /* Options display */
        .options-list {
            list-style: none;
            padding: 0;
        }
        
        .options-list li {
            padding: 0.5rem;
            margin-bottom: 0.25rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .options-list li.correct {
            border-left: 3px solid var(--success);
        }
        
        /* Filters */
        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        /* Quiz styles */
        .quiz-container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .quiz-progress {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1rem;
            background: rgba(26, 31, 58, 0.6);
            border-radius: 12px;
        }
        
        .progress-bar {
            flex: 1;
            height: 8px;
            background: rgba(0, 217, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.3s ease;
        }
        
        .quiz-question {
            background: rgba(26, 31, 58, 0.6);
            backdrop-filter: blur(10px);
            border: 2px solid var(--primary);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .quiz-question-text {
            font-size: 1.3rem;
            line-height: 1.8;
            margin-bottom: 2rem;
        }
        
        .options-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .option {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            background: rgba(10, 14, 39, 0.8);
            border: 2px solid rgba(0, 217, 255, 0.2);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .option:hover {
            border-color: var(--primary);
            background: rgba(0, 217, 255, 0.1);
        }
        
        .option.selected {
            border-color: var(--accent);
            background: rgba(255, 230, 109, 0.1);
        }
        
        .option.correct {
            border-color: var(--success);
            background: rgba(6, 255, 165, 0.1);
        }
        
        .option.incorrect {
            border-color: var(--danger);
            background: rgba(255, 0, 110, 0.1);
        }
        
        .option-letter {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary);
            color: var(--dark);
            border-radius: 50%;
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .option.selected .option-letter {
            background: var(--accent);
        }
        
        .option.correct .option-letter {
            background: var(--success);
        }
        
        .option.incorrect .option-letter {
            background: var(--danger);
            color: var(--white);
        }
        
        .option-text {
            flex: 1;
            font-size: 1.05rem;
        }
        
        /* Results */
        .results-panel {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }
        
        .results-score {
            font-family: 'Archivo Black', sans-serif;
            font-size: 5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 2rem 0;
        }
        
        .results-message {
            font-size: 1.5rem;
            color: var(--accent);
            margin-bottom: 2rem;
        }
        
        /* Video preview */
        .video-preview {
            margin-top: 0.5rem;
            border-radius: 8px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.5);
        }
        
        .video-preview iframe {
            width: 100%;
            height: 400px;
            border: none;
        }
        
        /* Loading state */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 39, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(0, 217, 255, 0.2);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 1rem;
            color: var(--primary);
            font-size: 1.2rem;
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem;
            opacity: 0.7;
        }
        
        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--accent);
        }
        
        /* PDF Worksheet Generator */
        .pdf-modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(10, 14, 39, 0.97);
            z-index: 10001;
            overflow-y: auto;
        }

        .pdf-modal-inner {
            max-width: 700px;
            margin: 3rem auto;
            padding: 2rem;
        }

        .pdf-modal h2 {
            font-size: 1.8rem;
            color: var(--primary);
            margin-bottom: 0.3rem;
        }

        .pdf-modal .subtitle {
            opacity: 0.6;
            margin-bottom: 2rem;
            font-size: 0.95rem;
        }

        .pdf-type-toggle {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .pdf-type-btn {
            flex: 1;
            padding: 1rem;
            border-radius: 12px;
            border: 2px solid rgba(0, 217, 255, 0.3);
            background: rgba(10, 14, 39, 0.8);
            color: var(--light);
            font-family: 'DM Sans', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .pdf-type-btn:hover { border-color: var(--primary); }

        .pdf-type-btn.active {
            border-color: var(--primary);
            background: rgba(0, 217, 255, 0.12);
            color: var(--primary);
        }

        .pdf-type-btn small {
            display: block;
            font-weight: 400;
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 0.3rem;
        }

        .available-count {
            display: inline-block;
            padding: 0.4rem 1rem;
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 20px;
            font-size: 0.9rem;
            color: var(--primary);
            margin-top: 0.5rem;
        }

        /* Print styles for PDF */
        @media print {
            body > * { display: none !important; }
            #pdfPrintArea { display: block !important; }
        }

        #pdfPrintArea {
            display: none;
            font-family: Arial, sans-serif;
            color: #000;
            background: #fff;
            padding: 0;
            margin: 0;
        }

        /* Analytics Dashboard */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(10, 14, 39, 0.8);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 14px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
        }

        .stat-card .stat-value {
            font-family: 'Archivo Black', sans-serif;
            font-size: 2.8rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.1;
        }

        .stat-card .stat-label {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-top: 0.4rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .student-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1.5fr;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.2rem;
            background: rgba(10, 14, 39, 0.6);
            border: 1px solid rgba(0, 217, 255, 0.15);
            border-radius: 10px;
            margin-bottom: 0.6rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .student-row:hover {
            border-color: var(--primary);
            background: rgba(0, 217, 255, 0.05);
        }

        .student-row.header-row {
            background: rgba(0, 217, 255, 0.1);
            border-color: var(--primary);
            cursor: default;
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--primary);
        }

        .student-row.header-row:hover {
            background: rgba(0, 217, 255, 0.1);
        }

        .score-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
        }

        .score-high { background: rgba(6, 255, 165, 0.15); color: var(--success); border: 1px solid var(--success); }
        .score-mid  { background: rgba(255, 230, 109, 0.15); color: var(--accent); border: 1px solid var(--accent); }
        .score-low  { background: rgba(255, 0, 110, 0.15); color: var(--danger); border: 1px solid var(--danger); }

        .topic-bar-container {
            margin-bottom: 0.8rem;
        }

        .topic-bar-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.3rem;
            font-size: 0.9rem;
        }

        .topic-bar-track {
            height: 10px;
            background: rgba(0, 217, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
        }

        .topic-bar-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.6s ease;
        }

        .drill-back-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 1rem;
            font-family: 'DM Sans', sans-serif;
            padding: 0;
            margin-bottom: 1.5rem;
        }

        .drill-back-btn:hover { opacity: 0.7; }

        .history-item {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr 1fr;
            gap: 1rem;
            padding: 0.9rem 1.2rem;
            background: rgba(10, 14, 39, 0.6);
            border: 1px solid rgba(0, 217, 255, 0.15);
            border-radius: 10px;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .analytics-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid rgba(0, 217, 255, 0.2);
            padding-bottom: 0;
        }

        .analytics-tab {
            padding: 0.6rem 1.4rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--light);
            font-family: 'DM Sans', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: -2px;
            transition: all 0.2s ease;
            opacity: 0.6;
        }

        .analytics-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            opacity: 1;
        }

        .analytics-tab:hover { opacity: 1; }

        .analytics-section { display: none; }
        .analytics-section.active { display: block; }

        /* Responsive */
        @media (max-width: 768px) {
            .welcome-title {
                font-size: 2.5rem;
            }
            
            .portal-cards {
                grid-template-columns: 1fr;
            }
            
            .checkbox-group {
                grid-template-columns: 1fr;
            }
            
            .filters {
                grid-template-columns: 1fr;
            }
        }
        
        /* ============================================ */
        /* AUTHENTICATION STYLES */
        /* ============================================ */
        
        .auth-view {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .auth-container {
            max-width: 500px;
            width: 100%;
        }
        
        .auth-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .auth-header .logo {
            font-family: 'Archivo Black', sans-serif;
            font-size: 3rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }
        
        .auth-subtitle {
            color: var(--light);
            opacity: 0.8;
            font-size: 1.1rem;
        }
        
        .auth-panel {
            background: rgba(26, 31, 58, 0.8);
            backdrop-filter: blur(10px);
            border: 2px solid var(--primary);
            border-radius: 16px;
            padding: 2.5rem;
            box-shadow: var(--shadow-lg);
        }
        
        .auth-panel h2 {
            color: var(--primary);
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
            text-align: center;
        }
        
        .auth-links {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 1.5rem;
            text-align: center;
        }
        
        .auth-links a {
            color: var(--accent);
            text-decoration: none;
            transition: color 0.3s ease;
            font-size: 0.95rem;
        }
        
        .auth-links a:hover {
            color: var(--primary);
        }
        
        .error-message {
            background: rgba(255, 0, 110, 0.15);
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.95rem;
        }
        
        .success-message {
            background: rgba(6, 255, 165, 0.15);
            border: 1px solid var(--success);
            color: var(--success);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.95rem;
        }
        
        /* Hide header and container when on auth pages */
        .auth-mode header,
        .auth-mode .container {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Connecting to database...</div>
    </div>

    <!-- Login View -->
    <div id="loginView" class="auth-view">
        <div class="auth-container">
            <div class="auth-header">
                <h1 class="logo">KhemBank</h1>
                <p class="auth-subtitle">Chemistry Question Bank System</p>
            </div>
            
            <div class="auth-panel">
                <h2>Login</h2>
                <form id="loginForm">
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="loginEmail" placeholder="your.email@example.com" required autocomplete="email">
                    </div>
                    
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter your password" required autocomplete="current-password">
                    </div>
                    
                    <div id="loginError" class="error-message" style="display: none;"></div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        Login
                    </button>
                </form>
                
                <div class="auth-links">
                    <a href="#" onclick="showAuthView('signup'); return false;">Student? Sign up here</a>
                    <a href="#" onclick="showAuthView('forgotPassword'); return false;">Forgot password?</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Signup View -->
    <div id="signupView" class="auth-view" style="display: none;">
        <div class="auth-container">
            <div class="auth-header">
                <h1 class="logo">KhemBank</h1>
                <p class="auth-subtitle">Student Registration</p>
            </div>
            
            <div class="auth-panel">
                <h2>Create Account</h2>
                <form id="signupForm">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="signupName" placeholder="John Doe" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="signupEmail" placeholder="your.email@example.com" required autocomplete="email">
                    </div>
                    
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="signupPassword" placeholder="Minimum 6 characters" required minlength="6" autocomplete="new-password">
                        <small style="opacity: 0.7;">Must be at least 6 characters</small>
                    </div>
                    
                    <div class="form-group">
                        <label>Join Code</label>
                        <input type="text" id="signupJoinCode" placeholder="Enter your join code (e.g., CHEM2026)" required style="text-transform: uppercase;">
                        <small style="opacity: 0.7;">Get this from your teacher</small>
                    </div>
                    
                    <div id="signupError" class="error-message" style="display: none;"></div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        Create Account
                    </button>
                </form>
                
                <div class="auth-links">
                    <a href="#" onclick="showAuthView('login'); return false;">Already have an account? Login</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Forgot Password View -->
    <div id="forgotPasswordView" class="auth-view" style="display: none;">
        <div class="auth-container">
            <div class="auth-header">
                <h1 class="logo">KhemBank</h1>
                <p class="auth-subtitle">Reset Password</p>
            </div>
            
            <div class="auth-panel">
                <h2>Forgot Password</h2>
                <p style="opacity: 0.8; margin-bottom: 1.5rem;">Enter your email and we'll send you a link to reset your password.</p>
                
                <form id="forgotPasswordForm">
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="resetEmail" placeholder="your.email@example.com" required autocomplete="email">
                    </div>
                    
                    <div id="resetError" class="error-message" style="display: none;"></div>
                    <div id="resetSuccess" class="success-message" style="display: none;"></div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        Send Reset Link
                    </button>
                </form>
                
                <div class="auth-links">
                    <a href="#" onclick="showAuthView('login'); return false;">Back to Login</a>
                </div>
            </div>
        </div>
    </div>

    <header>
        <div class="header-content">
            <div class="logo">KhemBank</div>
            <div class="connection-status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Connecting...</span>
            </div>
            <div class="nav-buttons" id="navButtons"></div>
        </div>
    </header>

    <div class="container">
        <!-- Welcome View -->
        <div id="welcomeView" class="view active">
            <div class="welcome-screen">
                <h1 class="welcome-title">KhemBank</h1>
                <p class="welcome-subtitle">Advanced Chemistry Question Bank System</p>
                <p class="welcome-info">üåê Cloud-powered with Supabase ‚Ä¢ Real-time synchronization ‚Ä¢ Built to scale</p>
                
                <div class="portal-cards">
                    <div class="portal-card" onclick="accessTeacherPortal()">
                        <h2>üéì Teacher Portal</h2>
                        <p>Upload questions, create quizzes, tag content by topic and difficulty, add video explanations, and manage your question bank.</p>
                    </div>
                    
                    <div class="portal-card" onclick="accessStudentPortal()">
                        <h2>üìö Student Portal</h2>
                        <p>Access quizzes, practice questions by topic and difficulty, view video explanations, and track your progress.</p>
                    </div>

                    <div class="portal-card" id="analyticsCard" style="display:none;" onclick="showView('analytics')">
                        <h2>üìä Analytics</h2>
                        <p>View student performance, track scores over time, identify weak topics, and drill down into individual student progress.</p>
                    </div>

                    <div class="portal-card" id="pdfCard" style="display:none;" onclick="openPdfModal()">
                        <h2>üñ®Ô∏è Print Worksheets</h2>
                        <p>Generate printable student worksheets or tutor answer keys. Filter by topic, difficulty, and number of questions.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin View -->
        <div id="adminView" class="view">
            <div class="panel">
                <div class="panel-header">
                    <span id="formPanelTitle">Upload Question</span>
                    <button id="cancelEditBtn" class="btn btn-secondary" onclick="cancelEdit()" style="display:none; padding: 0.5rem 1rem;">‚úï Cancel Edit</button>
                </div>
                
                <form id="questionForm">
                    <div class="form-group">
                        <label>Question Text (Supports LaTeX: Use \(...\) for inline math, \[...\] for display math)</label>
                        <textarea id="questionText" placeholder="E.g., Calculate the pH of a solution with \([H^+] = 1 \times 10^{-5}\) M" required></textarea>
                        <small style="opacity: 0.7;">LaTeX examples: \(E = mc^2\), \[H_2O + CO_2 \rightarrow H_2CO_3\]</small>
                    </div>
                    
                    <div class="form-group">
                        <label>Topic</label>
                        <select id="questionTopic" required>
                            <option value="">Select topic...</option>
                            <option value="Acid base equilibrium">Acid base equilibrium</option>
                            <option value="Atomic structure">Atomic structure</option>
                            <option value="Chemical bonding">Chemical bonding</option>
                            <option value="Chemical equilibrium">Chemical equilibrium</option>
                            <option value="Electrolysis">Electrolysis</option>
                            <option value="Electrochemical cell">Electrochemical cell</option>
                            <option value="Thermochemistry">Thermochemistry</option>
                            <option value="Thermodynamics">Thermodynamics</option>
                            <option value="Gases">Gases</option>
                            <option value="Kinetics">Kinetics</option>
                            <option value="Mole">Mole</option>
                            <option value="Periodic table">Periodic table</option>
                            <option value="Group 2">Group 2</option>
                            <option value="Group 17">Group 17</option>
                            <option value="Redox">Redox</option>
                            <option value="Transition elements">Transition elements</option>
                            <option value="Solubility">Solubility</option>
                            <option value="Introduction to Organic">Introduction to Organic</option>
                            <option value="Alkane">Alkane</option>
                            <option value="Alkene">Alkene</option>
                            <option value="Arene">Arene</option>
                            <option value="Halogenoalkane">Halogenoalkane</option>
                            <option value="Hydroxyl Compounds">Hydroxyl Compounds</option>
                            <option value="Carbonyl Compound">Carbonyl Compound</option>
                            <option value="Carboxylic Acid">Carboxylic Acid</option>
                            <option value="Nitrogen Compound">Nitrogen Compound</option>
                            <option value="Polymers">Polymers</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Difficulty</label>
                        <select id="questionDifficulty" required>
                            <option value="">Select difficulty...</option>
                            <option value="Easy">Easy</option>
                            <option value="Medium">Medium</option>
                            <option value="Hard">Hard</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Source (Optional)</label>
                        <select id="questionSource" onchange="toggleYearDropdown()">
                            <option value="">Select source...</option>
                            <option value="TYS">TYS (Ten Year Series)</option>
                            <option value="Prelim">Prelim</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="yearGroup" style="display: none;">
                        <label>Year</label>
                        <select id="questionYear">
                            <option value="">Select year...</option>
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                            <option value="2022">2022</option>
                            <option value="2021">2021</option>
                            <option value="2020">2020</option>
                            <option value="2019">2019</option>
                            <option value="2018">2018</option>
                            <option value="2017">2017</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="schoolGroup" style="display: none;">
                        <label>School <span style="color: var(--danger);">*</span></label>
                        <input type="text" id="questionSchool" placeholder="e.g., Raffles Institution, Hwa Chong, ACJC">
                        <small style="opacity: 0.7;">Required for Prelim questions</small>
                    </div>
                    
                    <div class="form-group">
                        <label>Options (One per line)</label>
                        <textarea id="questionOptions" placeholder="Option A
Option B
Option C
Option D" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Correct Answer</label>
                        <select id="correctAnswer" required>
                            <option value="">Select correct answer...</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Explanation (Optional)</label>
                        <textarea id="questionExplanation" placeholder="Provide a detailed explanation of the correct answer..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Question Image/Diagram (Optional)</label>
                        <input type="file" id="questionImage" accept="image/jpeg,image/jpg,image/png,image/gif,image/webp">
                        <small style="opacity: 0.7;">Upload diagrams, molecular structures, graphs, etc. (Max 5MB)</small>
                        <div id="existingImagePreview" style="margin-top: 0.5rem; display: none;">
                            <p style="font-size: 0.85rem; color: var(--accent); margin-bottom: 0.3rem;">Current image:</p>
                            <img id="existingImg" style="max-width: 300px; border-radius: 8px; border: 1px solid var(--primary);">
                            <br><button type="button" class="btn btn-danger" style="margin-top: 0.5rem; padding: 0.4rem 0.8rem; font-size: 0.8rem;" onclick="removeExistingImage()">Remove Image</button>
                        </div>
                        <div id="imagePreview" style="margin-top: 0.5rem; display: none;">
                            <img id="previewImg" style="max-width: 300px; border-radius: 8px; border: 1px solid var(--primary);">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Video URL (Optional - YouTube link)</label>
                        <input type="url" id="videoUrl" placeholder="https://www.youtube.com/watch?v=...">
                    </div>
                    
                    <div style="display: flex; gap: 1rem;">
                        <button type="button" class="btn btn-secondary" onclick="previewQuestion()">Preview Question</button>
                        <button type="submit" class="btn btn-primary" id="submitBtn">Upload Question</button>
                    </div>
                </form>
            </div>
            
            <div class="panel">
                <div class="panel-header">
                    <span>Question Bank (<span id="questionCount">0</span> questions)</span>
                </div>
                
                <div class="filters">
                    <div class="form-group">
                        <label>Filter by Topic</label>
                        <select id="filterTopic">
                            <option value="">All Topics</option>
                            <option value="Acid base equilibrium">Acid base equilibrium</option>
                            <option value="Atomic structure">Atomic structure</option>
                            <option value="Chemical bonding">Chemical bonding</option>
                            <option value="Chemical equilibrium">Chemical equilibrium</option>
                            <option value="Electrolysis">Electrolysis</option>
                            <option value="Electrochemical cell">Electrochemical cell</option>
                            <option value="Thermochemistry">Thermochemistry</option>
                            <option value="Thermodynamics">Thermodynamics</option>
                            <option value="Gases">Gases</option>
                            <option value="Kinetics">Kinetics</option>
                            <option value="Mole">Mole</option>
                            <option value="Periodic table">Periodic table</option>
                            <option value="Group 2">Group 2</option>
                            <option value="Group 17">Group 17</option>
                            <option value="Redox">Redox</option>
                            <option value="Transition elements">Transition elements</option>
                            <option value="Solubility">Solubility</option>
                            <option value="Introduction to Organic">Introduction to Organic</option>
                            <option value="Alkane">Alkane</option>
                            <option value="Alkene">Alkene</option>
                            <option value="Arene">Arene</option>
                            <option value="Halogenoalkane">Halogenoalkane</option>
                            <option value="Hydroxyl Compounds">Hydroxyl Compounds</option>
                            <option value="Carbonyl Compound">Carbonyl Compound</option>
                            <option value="Carboxylic Acid">Carboxylic Acid</option>
                            <option value="Nitrogen Compound">Nitrogen Compound</option>
                            <option value="Polymers">Polymers</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Filter by Difficulty</label>
                        <select id="filterDifficulty">
                            <option value="">All Difficulties</option>
                            <option value="Easy">Easy</option>
                            <option value="Medium">Medium</option>
                            <option value="Hard">Hard</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Filter by Source</label>
                        <select id="filterSource">
                            <option value="">All Sources</option>
                            <option value="TYS">TYS</option>
                            <option value="Prelim">Prelim</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                
                <div id="questionList"></div>
            </div>
        </div>

        <!-- Student View -->
        <div id="studentView" class="view">
            <div class="panel">
                <div class="panel-header">
                    <span>Select Quiz Parameters</span>
                </div>
                
                <div class="filters">
                    <div class="form-group">
                        <label>Topics (Select multiple)</label>
                        <div class="checkbox-group" id="topicCheckboxes">
                            <label class="checkbox-label" style="grid-column: 1 / -1; border-bottom: 1px solid rgba(0, 217, 255, 0.3); padding-bottom: 0.5rem; margin-bottom: 0.5rem;">
                                <input type="checkbox" id="selectAllTopics" onchange="toggleAllTopics()">
                                <span style="font-weight: 700; color: var(--accent);">‚úì All Topics</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Acid base equilibrium" class="topic-checkbox">
                                <span>Acid base equilibrium</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Atomic structure" class="topic-checkbox">
                                <span>Atomic structure</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Chemical bonding" class="topic-checkbox">
                                <span>Chemical bonding</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Chemical equilibrium" class="topic-checkbox">
                                <span>Chemical equilibrium</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Electrolysis" class="topic-checkbox">
                                <span>Electrolysis</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Electrochemical cell" class="topic-checkbox">
                                <span>Electrochemical cell</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Thermochemistry" class="topic-checkbox">
                                <span>Thermochemistry</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Thermodynamics" class="topic-checkbox">
                                <span>Thermodynamics</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Gases" class="topic-checkbox">
                                <span>Gases</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Kinetics" class="topic-checkbox">
                                <span>Kinetics</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Mole" class="topic-checkbox">
                                <span>Mole</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Periodic table" class="topic-checkbox">
                                <span>Periodic table</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Group 2" class="topic-checkbox">
                                <span>Group 2</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Group 17" class="topic-checkbox">
                                <span>Group 17</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Redox" class="topic-checkbox">
                                <span>Redox</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Transition elements" class="topic-checkbox">
                            <label class="checkbox-label">
                                <input type="checkbox" value="Solubility" class="topic-checkbox">
                                <span>Solubility</span>
                            </label>
                                <span>Transition elements</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Introduction to Organic" class="topic-checkbox">
                                <span>Introduction to Organic</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Alkane" class="topic-checkbox">
                                <span>Alkane</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Alkene" class="topic-checkbox">
                                <span>Alkene</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Arene" class="topic-checkbox">
                                <span>Arene</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Halogenoalkane" class="topic-checkbox">
                                <span>Halogenoalkane</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Hydroxyl Compounds" class="topic-checkbox">
                                <span>Hydroxyl Compounds</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Carbonyl Compound" class="topic-checkbox">
                                <span>Carbonyl Compound</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Carboxylic Acid" class="topic-checkbox">
                                <span>Carboxylic Acid</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Nitrogen Compound" class="topic-checkbox">
                                <span>Nitrogen Compound</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Polymers" class="topic-checkbox">
                                <span>Polymers</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Difficulties (Select multiple)</label>
                        <div class="checkbox-group" id="difficultyCheckboxes">
                            <label class="checkbox-label">
                                <input type="checkbox" value="Easy">
                                <span>Easy</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Medium">
                                <span>Medium</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Hard">
                                <span>Hard</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Sources & Years (Select multiple - Optional)</label>
                        <div id="sourceYearFilters" style="display: flex; flex-direction: column; gap: 1rem;">
                            <!-- TYS Years -->
                            <div>
                                <div style="font-weight: 600; color: var(--primary); margin-bottom: 0.5rem;">TYS (Ten Year Series)</div>
                                <div class="checkbox-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" class="source-checkbox" data-source="TYS" data-year="2025">
                                        <span>2025</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" class="source-checkbox" data-source="TYS" data-year="2024">
                                        <span>2024</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" class="source-checkbox" data-source="TYS" data-year="2023">
                                        <span>2023</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" class="source-checkbox" data-source="TYS" data-year="2022">
                                        <span>2022</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" class="source-checkbox" data-source="TYS" data-year="2021">
                                        <span>2021</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" class="source-checkbox" data-source="TYS" data-year="2020">
                                        <span>2020</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" class="source-checkbox" data-source="TYS" data-year="2019">
                                        <span>2019</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" class="source-checkbox" data-source="TYS" data-year="2018">
                                        <span>2018</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" class="source-checkbox" data-source="TYS" data-year="2017">
                                        <span>2017</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Prelim Years & Schools - will be populated dynamically -->
                            <div id="prelimFilters">
                                <div style="font-weight: 600; color: var(--primary); margin-bottom: 0.5rem;">Prelim (by School & Year)</div>
                                <div id="prelimSchoolsContainer" style="display: flex; flex-direction: column; gap: 0.5rem;">
                                    <div style="opacity: 0.7; font-size: 0.9rem;">Loading schools...</div>
                                </div>
                            </div>
                            
                            <!-- Other -->
                            <div>
                                <div style="font-weight: 600; color: var(--primary); margin-bottom: 0.5rem;">Other</div>
                                <div class="checkbox-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" class="source-checkbox" data-source="Other" data-year="">
                                        <span>Other Sources</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Number of Questions</label>
                        <input type="number" id="numQuestions" min="1" max="50" value="10">
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="startQuiz()">Start Quiz</button>
            </div>
        </div>

        <!-- Quiz View -->
        <div id="quizView" class="view">
            <div class="quiz-container">
                <div class="quiz-progress">
                    <span id="currentQuestion">Question 1</span>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <span id="totalQuestions">of 10</span>
                </div>
                
                <div class="quiz-question">
                    <div class="question-meta" style="margin-bottom: 1rem;">
                        <div class="tag-container" id="quizQuestionTags"></div>
                    </div>
                    
                    <div class="quiz-question-text" id="quizQuestionText"></div>
                    
                    <div class="options-container" id="quizOptions"></div>
                    
                    <div id="videoContainer" style="margin-top: 2rem; display: none;">
                        <label>Video Explanation</label>
                        <div class="video-preview" id="quizVideoPreview"></div>
                    </div>
                    
                    <div id="explanationContainer" style="margin-top: 2rem; display: none;">
                        <label>Explanation</label>
                        <div style="background: rgba(10, 14, 39, 0.8); padding: 1rem; border-radius: 8px; margin-top: 0.5rem;" id="quizExplanation"></div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button class="btn btn-secondary" id="prevBtn" onclick="previousQuestion()" disabled>Previous</button>
                    <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()">Next Question</button>
                    <button class="btn btn-success" id="quizSubmitBtn" onclick="submitQuiz()" style="display: none;">Submit Quiz</button>
                </div>
            </div>
        </div>

        <!-- Results View -->
        <div id="resultsView" class="view">
            <div class="panel results-panel">
                <div class="panel-header" style="justify-content: center;">
                    <span>Quiz Results</span>
                </div>
                
                <div class="results-score" id="finalScore">0%</div>
                <div class="results-message" id="resultsMessage">Great job!</div>
                
                <div style="text-align: left; margin-top: 2rem;" id="resultsBreakdown"></div>
                
                <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: center;">
                    <button class="btn btn-primary" onclick="showView('student')">Take Another Quiz</button>
                    <button class="btn btn-secondary" onclick="reviewQuiz()">Review Answers</button>
                </div>
            </div>
        </div>
    </div>

        <!-- Analytics View -->
        <div id="analyticsView" class="view">
            <!-- Overview panel -->
            <div id="analyticsOverview">
                <div class="panel">
                    <div class="panel-header">
                        <span>üìä Analytics Dashboard</span>
                        <button class="btn btn-secondary" onclick="loadAnalytics()" style="padding: 0.5rem 1rem; font-size: 0.85rem;">‚Üª Refresh</button>
                    </div>

                    <!-- Summary stats -->
                    <div class="analytics-grid" id="analyticsStats">
                        <div class="stat-card">
                            <div class="stat-value" id="statTotalStudents">‚Äî</div>
                            <div class="stat-label">Total Students</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statTotalQuizzes">‚Äî</div>
                            <div class="stat-label">Quizzes Taken</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statAvgScore">‚Äî</div>
                            <div class="stat-label">Class Average Score</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statWeakestTopic">‚Äî</div>
                            <div class="stat-label">Most Struggled Topic</div>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="analytics-tabs">
                        <button class="analytics-tab active" onclick="switchAnalyticsTab('students', this)">üë• Students</button>
                        <button class="analytics-tab" onclick="switchAnalyticsTab('topics', this)">üìö Topics</button>
                    </div>

                    <!-- Students tab -->
                    <div id="analyticsStudents" class="analytics-section active">
                        <div id="studentTableContainer">
                            <div class="empty-state"><h3>Loading student data...</h3></div>
                        </div>
                    </div>

                    <!-- Topics tab -->
                    <div id="analyticsTopics" class="analytics-section">
                        <div id="topicChartContainer">
                            <div class="empty-state"><h3>Loading topic data...</h3></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Student drill-down panel (hidden by default) -->
            <div id="analyticsDrilldown" style="display:none;">
                <div class="panel">
                    <button class="drill-back-btn" onclick="closeDrilldown()">‚Üê Back to All Students</button>
                    <div id="drilldownContent"></div>
                </div>
            </div>
        </div>

    <!-- PDF Worksheet Generator Modal -->
    <div id="pdfModal" class="pdf-modal">
        <div class="pdf-modal-inner">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.3rem;">
                <h2>üñ®Ô∏è Print Worksheet</h2>
                <button class="btn btn-danger" onclick="closePdfModal()">‚úï Close</button>
            </div>
            <p class="subtitle">Generate a printable PDF for students or a tutor answer key.</p>

            <!-- Version toggle -->
            <div class="pdf-type-toggle">
                <button class="pdf-type-btn active" id="pdfTypeStudent" onclick="setPdfType('student')">
                    üìÑ Student Version
                    <small>Questions only ‚Äî no answers</small>
                </button>
                <button class="pdf-type-btn" id="pdfTypeTutor" onclick="setPdfType('tutor')">
                    üîë Tutor Version
                    <small>Includes answers & explanations</small>
                </button>
            </div>

            <!-- Filters -->
            <div class="panel" style="padding:1.5rem; margin-bottom:1.5rem;">
                <div class="form-group">
                    <label>Topic <span style="color:var(--danger);">*</span></label>
                    <select id="pdfTopic">
                        <option value="">Select a topic...</option>
                        <option value="Acid base equilibrium">Acid base equilibrium</option>
                        <option value="Atomic structure">Atomic structure</option>
                        <option value="Chemical bonding">Chemical bonding</option>
                        <option value="Chemical equilibrium">Chemical equilibrium</option>
                        <option value="Electrolysis">Electrolysis</option>
                        <option value="Electrochemical cell">Electrochemical cell</option>
                        <option value="Thermochemistry">Thermochemistry</option>
                        <option value="Thermodynamics">Thermodynamics</option>
                        <option value="Gases">Gases</option>
                        <option value="Kinetics">Kinetics</option>
                        <option value="Mole">Mole</option>
                        <option value="Periodic table">Periodic table</option>
                        <option value="Group 2">Group 2</option>
                        <option value="Group 17">Group 17</option>
                        <option value="Redox">Redox</option>
                        <option value="Solubility">Solubility</option>
                        <option value="Transition elements">Transition elements</option>
                        <option value="Introduction to Organic">Introduction to Organic</option>
                        <option value="Alkane">Alkane</option>
                        <option value="Alkene">Alkene</option>
                        <option value="Arene">Arene</option>
                        <option value="Halogenoalkane">Halogenoalkane</option>
                        <option value="Hydroxyl Compounds">Hydroxyl Compounds</option>
                        <option value="Carbonyl Compound">Carbonyl Compound</option>
                        <option value="Carboxylic Acid">Carboxylic Acid</option>
                        <option value="Nitrogen Compound">Nitrogen Compound</option>
                        <option value="Polymers">Polymers</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Difficulty</label>
                    <div style="display:flex; gap:1rem; flex-wrap:wrap; margin-top:0.5rem;">
                        <label class="checkbox-label">
                            <input type="checkbox" class="pdf-diff-cb" value="Easy" checked> Easy
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" class="pdf-diff-cb" value="Medium" checked> Medium
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" class="pdf-diff-cb" value="Hard" checked> Hard
                        </label>
                    </div>
                </div>

                <div class="form-group" style="margin-bottom:0;">
                    <label>Number of Questions</label>
                    <input type="number" id="pdfNumQuestions" min="1" max="50" value="10" style="max-width:120px;">
                    <div id="pdfAvailableCount" class="available-count" style="display:none;"></div>
                </div>
            </div>

            <!-- Worksheet title (optional) -->
            <div class="form-group">
                <label>Worksheet Title (Optional)</label>
                <input type="text" id="pdfTitle" placeholder="e.g. Kinetics Practice ‚Äî Set 1">
            </div>

            <div style="display:flex; gap:1rem; margin-top:1rem;">
                <button class="btn btn-secondary" onclick="checkPdfAvailability()" style="flex:1;">
                    Check Availability
                </button>
                <button class="btn btn-primary" onclick="generateAndPrintPdf()" style="flex:2;">
                    üñ®Ô∏è Generate & Print PDF
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden print area -->
    <div id="pdfPrintArea"></div>

    <!-- Preview Modal -->
    <div id="previewModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 14, 39, 0.95); z-index: 10000; overflow-y: auto;">
        <div style="max-width: 900px; margin: 2rem auto; padding: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2 style="color: var(--primary); font-size: 1.8rem;">Question Preview</h2>
                <button class="btn btn-danger" onclick="closePreview()">Close Preview</button>
            </div>
            
            <div class="quiz-question" id="previewContent">
                <!-- Preview content will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // SUPABASE CONFIGURATION
        // ============================================
        
        const SUPABASE_URL = 'https://fvjqsohhitpnkvfirosc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ2anFzb2hoaXRwbmt2Zmlyb3NjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2MDI5OTUsImV4cCI6MjA4NjE3ODk5NX0.EysWH7XML4y-ezkoc0NJ_IYExFA4kvtBpx2DrqylgCU';
        
        // CRITICAL: Check for password reset BEFORE Supabase SDK processes the hash
        // This must run before createClient()
        let isPasswordRecovery = false;
        const initialHash = window.location.hash;
        
        // Check if we've already handled password reset in this session
        const passwordResetHandled = sessionStorage.getItem('passwordResetHandled');
        
        if (initialHash.includes('type=recovery') && !passwordResetHandled) {
            console.log('Password recovery detected in initial hash:', initialHash);
            isPasswordRecovery = true;
            // Mark that we're handling it now
            sessionStorage.setItem('passwordResetHandled', 'true');
        }
        
        // Initialize Supabase client
        const { createClient } = supabase;
        let supabaseClient;
        let isConnected = false;

        // ============================================
        // AUTHENTICATION STATE
        // ============================================
        let currentUser = null;
        let userRole = null;
        let userProfile = null;
        let isCheckingAuth = false; // Prevent re-entry

        try {
            supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            testConnection();
        } catch (error) {
            console.error('Supabase initialization error:', error);
            alert('Error connecting to database. Please check your Supabase configuration.');
            document.getElementById('loadingOverlay').style.display = 'none';
        }
        
        // Image preview handler
        document.addEventListener('DOMContentLoaded', () => {
            const imageInput = document.getElementById('questionImage');
            if (imageInput) {
                imageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        // Check file size (5MB limit)
                        if (file.size > 5 * 1024 * 1024) {
                            alert('Image size must be less than 5MB');
                            this.value = '';
                            return;
                        }
                        
                        // Preview image
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            document.getElementById('previewImg').src = e.target.result;
                            document.getElementById('imagePreview').style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    } else {
                        document.getElementById('imagePreview').style.display = 'none';
                    }
                });
            }
        });

        async function testConnection() {
            const timeout = setTimeout(() => {
                console.error('Connection timeout');
                isConnected = false;
                updateConnectionStatus(false);
                document.getElementById('loadingOverlay').style.display = 'none';
                showAuthView('login');
            }, 10000); // 10 second timeout
            
            try {
                const { data, error } = await supabaseClient
                    .from('questions')
                    .select('count', { count: 'exact', head: true });
                
                clearTimeout(timeout);
                
                if (error && error.code !== 'PGRST116') { // PGRST116 = table doesn't exist yet
                    console.error('Database connection error:', error);
                    throw error;
                }
                
                isConnected = true;
                updateConnectionStatus(true);
                
                // Check authentication state after connection
                await checkAuthState();
            } catch (error) {
                clearTimeout(timeout);
                console.error('Connection test failed:', error);
                console.error('Error details:', error.message, error.code);
                isConnected = false;
                updateConnectionStatus(false);
                document.getElementById('loadingOverlay').style.display = 'none';
                
                // Show more helpful error message
                const errorMsg = error.message || 'Unknown error';
                console.error('Full error:', errorMsg);
                
                // Still show login even if connection fails
                showAuthView('login');
            }
        }

        // ============================================
        // AUTHENTICATION FUNCTIONS
        // ============================================
        
        async function checkAuthState() {
            // Prevent re-entry
            if (isCheckingAuth) {
                console.log('checkAuthState already running, skipping...');
                return;
            }
            
            isCheckingAuth = true;
            
            console.log('=== CHECKING AUTH STATE ===');
            console.log('isPasswordRecovery flag:', isPasswordRecovery);
            
            try {
                // CRITICAL: Check the flag we set BEFORE Supabase processed the URL
                if (isPasswordRecovery) {
                    console.log('Password recovery detected from initial flag - showing reset form');
                    document.getElementById('loadingOverlay').style.display = 'none';
                    showPasswordResetForm();
                    return; // Stop here, don't proceed with normal login
                }
                
                // Check for password reset or errors in URL hash
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                const type = hashParams.get('type');
                const error = hashParams.get('error');
                const errorCode = hashParams.get('error_code');
                const errorDescription = hashParams.get('error_description');
                
                // Handle password reset link errors (expired, invalid, etc.)
                if (error) {
                    console.log('Auth error detected:', error, errorCode, errorDescription);
                    document.getElementById('loadingOverlay').style.display = 'none';
                    
                    let errorMessage = 'An error occurred.';
                    if (errorCode === 'otp_expired') {
                        errorMessage = 'This password reset link has expired. Please request a new one.';
                    } else if (errorDescription) {
                        errorMessage = decodeURIComponent(errorDescription.replace(/\+/g, ' '));
                    }
                    
                    // Clear the error from URL
                    window.location.hash = '';
                    
                    // Show login page with error message
                    showAuthView('login');
                    
                    setTimeout(() => {
                        alert(errorMessage + '\n\nClick "Forgot password?" to request a new reset link.');
                    }, 500);
                    
                    return;
                }
                
                // Fallback: Check URL hash again (in case flag didn't catch it)
                if (type === 'recovery') {
                    console.log('Password recovery detected in hash - showing reset form');
                    document.getElementById('loadingOverlay').style.display = 'none';
                    showPasswordResetForm();
                    return;
                }
                
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                
                console.log('Session check result:', { session, error: sessionError });
                
                if (sessionError) {
                    console.error('Session check error:', sessionError);
                    showAuthView('login');
                    return;
                }
                
                if (!session) {
                    console.log('No active session - showing login');
                    showAuthView('login');
                    return;
                }
                
                console.log('User ID from session:', session.user.id);
                console.log('User email from session:', session.user.email);
                
                // Get user profile
                console.log('Fetching user profile from user_profiles table...');
                const { data: profile, error: profileError } = await supabaseClient
                    .from('user_profiles')
                    .select('*')
                    .eq('id', session.user.id)
                    .single();
                
                console.log('Profile query result:', { profile, profileError });
                
                if (profileError) {
                    console.error('Profile fetch error details:', {
                        message: profileError.message,
                        code: profileError.code,
                        details: profileError.details,
                        hint: profileError.hint
                    });
                    
                    // If profile doesn't exist, user might have been created outside the system
                    alert('User profile not found. Please contact the administrator.\n\nDebug info:\n' + JSON.stringify(profileError, null, 2));
                    await logout();
                    return;
                }
                
                if (!profile) {
                    console.error('Profile is null but no error was returned');
                    alert('Profile returned null. Check console for details.');
                    await logout();
                    return;
                }
                
                console.log('Profile loaded successfully:', profile);
                
                currentUser = session.user;
                userProfile = profile;
                userRole = profile.role;
                
                console.log('Authenticated as:', profile.email, '- Role:', profile.role);
                
                // Hide auth views, show main app
                hideAuthViews();
                loadQuestionsFromSupabase();
                
                // Redirect based on role
                redirectBasedOnRole();
                
                // Log user activity (non-critical, don't fail if it errors)
                try {
                    await supabaseClient.rpc('log_user_activity', {
                        p_user_id: session.user.id,
                        p_activity_type: 'login'
                    });
                    console.log('User activity logged');
                } catch (activityError) {
                    console.log('Activity logging failed (non-critical):', activityError.message);
                }
                
            } catch (error) {
                console.error('Auth state check failed:', error);
                alert('Authentication check failed: ' + error.message);
                showAuthView('login');
            } finally {
                // Always reset the guard flag
                isCheckingAuth = false;
            }
        }
        
        function showPasswordResetForm() {
            // Reset the flag
            isPasswordRecovery = false;
            
            document.body.classList.add('auth-mode');
            document.getElementById('loadingOverlay').style.display = 'none';
            
            // Hide all views
            const authViews = ['loginView', 'signupView', 'forgotPasswordView'];
            authViews.forEach(view => {
                document.getElementById(view).style.display = 'none';
            });
            
            // Create and show password reset form
            const resetFormHTML = `
                <div id="resetPasswordView" class="auth-view" style="display: flex;">
                    <div class="auth-container">
                        <div class="auth-header">
                            <h1 class="logo">KhemBank</h1>
                            <p class="auth-subtitle">Set New Password</p>
                        </div>
                        
                        <div class="auth-panel">
                            <h2>Enter New Password</h2>
                            <form id="resetPasswordForm">
                                <div class="form-group">
                                    <label>New Password</label>
                                    <input type="password" id="newPassword" placeholder="Enter new password" required minlength="6">
                                    <small style="opacity: 0.7;">Must be at least 6 characters</small>
                                </div>
                                
                                <div class="form-group">
                                    <label>Confirm Password</label>
                                    <input type="password" id="confirmPassword" placeholder="Confirm new password" required minlength="6">
                                </div>
                                
                                <div id="resetPasswordError" class="error-message" style="display: none;"></div>
                                <div id="resetPasswordSuccess" class="success-message" style="display: none;"></div>
                                
                                <button type="submit" class="btn btn-primary" style="width: 100%;">
                                    Update Password
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            // Add to DOM if doesn't exist
            if (!document.getElementById('resetPasswordView')) {
                const header = document.querySelector('header');
                header.insertAdjacentHTML('beforebegin', resetFormHTML);
            } else {
                document.getElementById('resetPasswordView').style.display = 'flex';
            }
            
            // Attach form handler
            const resetForm = document.getElementById('resetPasswordForm');
            resetForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                const errorDiv = document.getElementById('resetPasswordError');
                const successDiv = document.getElementById('resetPasswordSuccess');
                const submitBtn = resetForm.querySelector('button[type="submit"]');
                
                errorDiv.style.display = 'none';
                successDiv.style.display = 'none';
                
                if (newPassword !== confirmPassword) {
                    errorDiv.textContent = 'Passwords do not match!';
                    errorDiv.style.display = 'block';
                    return;
                }
                
                submitBtn.disabled = true;
                submitBtn.textContent = 'Updating...';
                
                try {
                    const { error } = await supabaseClient.auth.updateUser({
                        password: newPassword
                    });
                    
                    if (error) throw error;
                    
                    successDiv.textContent = 'Password updated successfully! Redirecting to login...';
                    successDiv.style.display = 'block';
                    
                    // CRITICAL: Clear everything to prevent loop
                    history.replaceState(null, null, ' ');
                    window.location.hash = '';
                    isPasswordRecovery = false;
                    sessionStorage.removeItem('passwordResetHandled'); // Clear the flag
                    
                    setTimeout(() => {
                        // Remove the reset form from DOM
                        const resetView = document.getElementById('resetPasswordView');
                        if (resetView) {
                            resetView.remove();
                        }
                        
                        showAuthView('login');
                    }, 2000);
                    
                } catch (error) {
                    console.error('Password update error:', error);
                    errorDiv.textContent = error.message || 'Failed to update password.';
                    errorDiv.style.display = 'block';
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Update Password';
                }
            });
        }
        
        function redirectBasedOnRole() {
            document.getElementById('loadingOverlay').style.display = 'none';
            
            if (userRole === 'admin') {
                // Admin sees welcome view initially (can access all portals)
                const analyticsCard = document.getElementById('analyticsCard');
                if (analyticsCard) analyticsCard.style.display = 'block';
                const pdfCard = document.getElementById('pdfCard');
                if (pdfCard) pdfCard.style.display = 'block';
                showView('welcome');
            } else if (userRole === 'teacher') {
                // Teachers go straight to teacher portal
                showView('admin');
            } else if (userRole === 'student' || userRole === 'premium_student') {
                // Students go to student portal
                showView('student');
            }
        }
        
        function showAuthView(viewName) {
            document.body.classList.add('auth-mode');
            document.getElementById('loadingOverlay').style.display = 'none';
            
            // Hide all auth views
            const authViews = ['loginView', 'signupView', 'forgotPasswordView'];
            authViews.forEach(view => {
                document.getElementById(view).style.display = 'none';
            });
            
            // Show requested view
            document.getElementById(viewName + 'View').style.display = 'flex';
            
            // Reset forms when showing auth views
            if (viewName === 'login') {
                // Use setTimeout to ensure DOM is ready
                setTimeout(() => {
                    const loginForm = document.getElementById('loginForm');
                    if (loginForm) {
                        loginForm.reset();
                        const submitBtn = loginForm.querySelector('button[type="submit"]');
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'Login';
                        }
                    }
                    const loginError = document.getElementById('loginError');
                    if (loginError) {
                        loginError.style.display = 'none';
                    }
                }, 100);
            }
        }
        
        function hideAuthViews() {
            document.body.classList.remove('auth-mode');
            const authViews = ['loginView', 'signupView', 'forgotPasswordView'];
            authViews.forEach(view => {
                document.getElementById(view).style.display = 'none';
            });
        }
        
        // Login Form Handler
        document.addEventListener('DOMContentLoaded', () => {
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const email = document.getElementById('loginEmail').value.trim();
                    const password = document.getElementById('loginPassword').value;
                    
                    const submitBtn = loginForm.querySelector('button[type="submit"]');
                    const errorDiv = document.getElementById('loginError');
                    
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Logging in...';
                    errorDiv.style.display = 'none';
                    
                    try {
                        const { data, error } = await supabaseClient.auth.signInWithPassword({
                            email: email,
                            password: password
                        });
                        
                        if (error) throw error;
                        
                        // Session is automatically stored by Supabase
                        // checkAuthState will be called and handle the redirect
                        await checkAuthState();
                        
                    } catch (error) {
                        console.error('Login error:', error);
                        errorDiv.textContent = error.message || 'Login failed. Please check your credentials.';
                        errorDiv.style.display = 'block';
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Login';
                    }
                });
            }
        });
        
        // Signup Form Handler
        document.addEventListener('DOMContentLoaded', () => {
            const signupForm = document.getElementById('signupForm');
            if (signupForm) {
                signupForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const name = document.getElementById('signupName').value.trim();
                    const email = document.getElementById('signupEmail').value.trim();
                    const password = document.getElementById('signupPassword').value;
                    const joinCode = document.getElementById('signupJoinCode').value.trim().toUpperCase();
                    
                    const submitBtn = signupForm.querySelector('button[type="submit"]');
                    const errorDiv = document.getElementById('signupError');
                    
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Creating account...';
                    errorDiv.style.display = 'none';
                    
                    try {
                        // Validate join code
                        const { data: codeData, error: codeError } = await supabaseClient
                            .from('join_codes')
                            .select('*')
                            .eq('code', joinCode)
                            .eq('is_active', true)
                            .single();
                        
                        if (codeError || !codeData) {
                            throw new Error('Invalid or expired join code');
                        }
                        
                        // Check max uses
                        if (codeData.max_uses && codeData.times_used >= codeData.max_uses) {
                            throw new Error('This join code has reached its maximum uses');
                        }
                        
                        // Create auth account
                        const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                            email: email,
                            password: password,
                            options: {
                                data: { full_name: name }
                            }
                        });
                        
                        if (authError) throw authError;
                        
                        // Create user profile ‚Äî use role assigned by join code
                        const assignedRole = codeData.assigned_role || 'student';
                        const { error: profileError } = await supabaseClient
                            .from('user_profiles')
                            .insert([{
                                id: authData.user.id,
                                email: email,
                                full_name: name,
                                role: assignedRole
                            }]);
                        
                        if (profileError) {
                            throw new Error('Account created but profile setup failed. Please contact support.');
                        }
                        
                        // Increment join code usage
                        await supabaseClient
                            .from('join_codes')
                            .update({ times_used: codeData.times_used + 1 })
                            .eq('id', codeData.id);
                        
                        // Auto-login (session is already created by signUp)
                        alert('Account created successfully! Welcome to KhemBank!');
                        await checkAuthState();
                        
                    } catch (error) {
                        console.error('Signup error:', error);
                        errorDiv.textContent = error.message || 'Signup failed. Please try again.';
                        errorDiv.style.display = 'block';
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Create Account';
                    }
                });
            }
        });
        
        // Forgot Password Form Handler
        document.addEventListener('DOMContentLoaded', () => {
            const forgotForm = document.getElementById('forgotPasswordForm');
            if (forgotForm) {
                forgotForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const email = document.getElementById('resetEmail').value.trim();
                    
                    const submitBtn = forgotForm.querySelector('button[type="submit"]');
                    const errorDiv = document.getElementById('resetError');
                    const successDiv = document.getElementById('resetSuccess');
                    
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Sending...';
                    errorDiv.style.display = 'none';
                    successDiv.style.display = 'none';
                    
                    try {
                        const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
                            redirectTo: 'https://mrkhemistry.github.io/chembank/'
                        });
                        
                        if (error) throw error;
                        
                        successDiv.textContent = 'Password reset email sent! Please check your inbox.';
                        successDiv.style.display = 'block';
                        submitBtn.textContent = 'Sent!';
                        
                        // Reset form after 3 seconds
                        setTimeout(() => {
                            showAuthView('login');
                        }, 3000);
                        
                    } catch (error) {
                        console.error('Password reset error:', error);
                        errorDiv.textContent = error.message || 'Failed to send reset email.';
                        errorDiv.style.display = 'block';
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Send Reset Link';
                    }
                });
            }
        });
        
        async function logout() {
            try {
                await supabaseClient.auth.signOut();
                currentUser = null;
                userRole = null;
                userProfile = null;
                questionBank = [];
                
                // Show login view first
                showAuthView('login');
                
                // Then reset login form button state with multiple attempts to ensure it works
                setTimeout(() => {
                    resetLoginButton();
                }, 50);
                
                setTimeout(() => {
                    resetLoginButton();
                }, 200);
                
            } catch (error) {
                console.error('Logout error:', error);
                alert('Logout failed: ' + error.message);
            }
        }
        
        function resetLoginButton() {
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                const submitBtn = loginForm.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Login';
                    console.log('Login button reset');
                }
            }
            
            // Clear any error messages
            const loginError = document.getElementById('loginError');
            if (loginError) {
                loginError.style.display = 'none';
            }
        }

        function updateConnectionStatus(connected) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            if (connected) {
                statusDot.classList.add('connected');
                statusText.textContent = 'Connected';
            } else {
                statusDot.classList.remove('connected');
                statusText.textContent = 'Disconnected';
            }
        }

        // ============================================
        // DATA MANAGEMENT
        // ============================================
        let questionBank = [];
        let currentQuiz = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];

        async function loadQuestionsFromSupabase() {
            try {
                console.log('Loading questions from Supabase...');
                const { data, error } = await supabaseClient
                    .from('questions')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(1000); // Limit to 1000 most recent questions for faster loading
                
                if (error) throw error;
                
                console.log('Questions loaded:', data?.length || 0);
                questionBank = data || [];
                displayQuestions();
                updateQuestionCount();
                buildPrelimSchoolFilters(); // Build school filters
                document.getElementById('loadingOverlay').style.display = 'none';
            } catch (error) {
                console.error('Error loading questions:', error);
                alert('Error loading questions: ' + error.message);
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        function buildPrelimSchoolFilters() {
            // Get unique school-year combinations from Prelim questions
            const prelimQuestions = questionBank.filter(q => q.source === 'Prelim' && q.school && q.source_year);
            
            // Group by year, then by school
            const schoolsByYear = {};
            prelimQuestions.forEach(q => {
                const year = q.source_year;
                const school = q.school;
                
                if (!schoolsByYear[year]) {
                    schoolsByYear[year] = new Set();
                }
                schoolsByYear[year].add(school);
            });
            
            // Build HTML
            const container = document.getElementById('prelimSchoolsContainer');
            
            if (Object.keys(schoolsByYear).length === 0) {
                container.innerHTML = '<div style="opacity: 0.7; font-size: 0.9rem;">No Prelim questions available yet</div>';
                return;
            }
            
            // Sort years descending
            const years = Object.keys(schoolsByYear).map(Number).sort((a, b) => b - a);
            
            let html = '';
            years.forEach(year => {
                const schools = Array.from(schoolsByYear[year]).sort();
                
                html += `
                    <div style="margin-bottom: 1rem;">
                        <div style="font-weight: 600; color: var(--accent); margin-bottom: 0.5rem; font-size: 0.95rem;">${year}</div>
                        <div class="checkbox-group" style="margin-left: 1rem;">
                `;
                
                schools.forEach(school => {
                    html += `
                        <label class="checkbox-label">
                            <input type="checkbox" class="source-checkbox" data-source="Prelim" data-year="${year}" data-school="${escapeHtml(school)}">
                            <span>${escapeHtml(school)}</span>
                        </label>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        async function addQuestionToSupabase(question) {
            if (!isConnected) {
                alert('Not connected to database. Please check your connection.');
                return;
            }
            
            try {
                const { data, error } = await supabaseClient
                    .from('questions')
                    .insert([{
                        text: question.text,
                        topic: question.topic,
                        difficulty: question.difficulty,
                        options: question.options,
                        correct_answer: question.correctAnswer,
                        explanation: question.explanation,
                        video_url: question.videoUrl,
                        source: question.source,
                        source_year: question.sourceYear,
                        school: question.school,
                        image_url: question.imageUrl
                    }])
                    .select();
                
                if (error) throw error;
                
                alert('Question added successfully!');
                document.getElementById('questionForm').reset();
                document.getElementById('yearGroup').style.display = 'none';
                document.getElementById('schoolGroup').style.display = 'none';
                document.getElementById('imagePreview').style.display = 'none';
                document.getElementById('existingImagePreview').style.display = 'none';
                editingQuestionId = null;
                editingImageUrl = null;
                loadQuestionsFromSupabase();
            } catch (error) {
                console.error('Error adding question:', error);
                alert('Error adding question to database: ' + error.message);
            }
        }

        async function deleteQuestionFromSupabase(id) {
            if (!isConnected) {
                alert('Not connected to database. Please check your connection.');
                return;
            }
            
            if (confirm('Are you sure you want to delete this question?')) {
                try {
                    const { error } = await supabaseClient
                        .from('questions')
                        .delete()
                        .eq('id', id);
                    
                    if (error) throw error;
                    
                    alert('Question deleted successfully!');
                    loadQuestionsFromSupabase();
                } catch (error) {
                    console.error('Error deleting question:', error);
                    alert('Error deleting question from database.');
                }
            }
        }

        // ============================================
        // FORM HANDLING
        // ============================================
        
        function previewQuestion() {
            // Get form values
            const questionText = document.getElementById('questionText').value.trim();
            const topic = document.getElementById('questionTopic').value;
            const difficulty = document.getElementById('questionDifficulty').value;
            const optionsText = document.getElementById('questionOptions').value.trim();
            const correctAnswer = document.getElementById('correctAnswer').value;
            const explanation = document.getElementById('questionExplanation').value.trim();
            const videoUrl = document.getElementById('videoUrl').value.trim();
            const source = document.getElementById('questionSource').value;
            const year = document.getElementById('questionYear').value;
            const school = document.getElementById('questionSchool').value.trim();
            const imageFile = document.getElementById('questionImage').files[0];
            
            // Validate required fields
            if (!questionText) {
                alert('Please enter a question text');
                return;
            }
            if (!topic) {
                alert('Please select a topic');
                return;
            }
            if (!difficulty) {
                alert('Please select a difficulty');
                return;
            }
            if (!optionsText) {
                alert('Please enter options');
                return;
            }
            if (!correctAnswer) {
                alert('Please select the correct answer');
                return;
            }
            
            // Parse options
            const options = optionsText.split('\n').filter(opt => opt.trim() !== '');
            if (options.length < 2) {
                alert('Please provide at least 2 options');
                return;
            }
            
            // Build source tag
            let sourceTag = '';
            if (source) {
                let sourceText = source;
                if (year) sourceText += ` ${year}`;
                if (school && source === 'Prelim') sourceText += ` - ${school}`;
                sourceTag = `<span class="tag" style="background: var(--secondary); color: var(--white);">${escapeHtml(sourceText)}</span>`;
            }
            
            // Build preview HTML - don't escape question text so LaTeX can render
            let previewHTML = `
                <div class="question-meta" style="margin-bottom: 1rem;">
                    <div class="tag-container">
                        <span class="tag tag-topic">${escapeHtml(topic)}</span>
                        <span class="tag tag-difficulty ${difficulty.toLowerCase()}">${difficulty}</span>
                        ${sourceTag}
                    </div>
                </div>
                
                <div class="quiz-question-text" style="font-size: 1.3rem; line-height: 1.8; margin-bottom: 2rem;">
                    ${questionText}
                </div>
            `;
            
            // Add image preview if file selected
            if (imageFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageHTML = `
                        <div style="margin: 1.5rem 0; text-align: center;">
                            <img src="${e.target.result}" style="max-width: 100%; max-height: 400px; border-radius: 12px; border: 2px solid var(--primary); box-shadow: var(--shadow-md);">
                        </div>
                    `;
                    document.getElementById('previewContent').insertAdjacentHTML('beforeend', imageHTML);
                };
                reader.readAsDataURL(imageFile);
            }
            
            // Add options
            previewHTML += '<div class="options-container" style="display: flex; flex-direction: column; gap: 1rem;">';
            options.forEach((option, index) => {
                const letter = String.fromCharCode(65 + index);
                const isCorrect = letter === correctAnswer;
                previewHTML += `
                    <div class="option ${isCorrect ? 'correct' : ''}" style="pointer-events: none;">
                        <div class="option-letter">${letter}</div>
                        <div class="option-text">${escapeHtml(option)}</div>
                        ${isCorrect ? '<span style="margin-left: auto; color: var(--success);">‚úì Correct Answer</span>' : ''}
                    </div>
                `;
            });
            previewHTML += '</div>';
            
            // Add explanation if provided
            if (explanation) {
                previewHTML += `
                    <div style="margin-top: 2rem; padding: 1rem; background: rgba(10, 14, 39, 0.8); border-radius: 8px; border-left: 3px solid var(--accent);">
                        <strong style="color: var(--accent);">Explanation:</strong><br>
                        <div style="margin-top: 0.5rem;">${explanation}</div>
                    </div>
                `;
            }
            
            // Add video if provided
            if (videoUrl) {
                let embedUrl = videoUrl;
                if (embedUrl.includes('youtube.com/watch')) {
                    const videoId = embedUrl.split('v=')[1]?.split('&')[0];
                    embedUrl = `https://www.youtube.com/embed/${videoId}`;
                } else if (embedUrl.includes('youtu.be')) {
                    const videoId = embedUrl.split('youtu.be/')[1]?.split('?')[0];
                    embedUrl = `https://www.youtube.com/embed/${videoId}`;
                }
                
                previewHTML += `
                    <div style="margin-top: 2rem;">
                        <strong style="color: var(--primary);">Video Explanation:</strong>
                        <div style="margin-top: 0.5rem; border-radius: 8px; overflow: hidden;">
                            <iframe width="100%" height="400" src="${embedUrl}" frameborder="0" allowfullscreen></iframe>
                        </div>
                    </div>
                `;
            }
            
            // Show preview
            document.getElementById('previewContent').innerHTML = previewHTML;
            document.getElementById('previewModal').style.display = 'block';
            
            // Render math if MathJax is available - with delay to ensure DOM is ready
            setTimeout(() => {
                if (window.MathJax) {
                    MathJax.typesetPromise([document.getElementById('previewContent')])
                        .catch((err) => console.log('MathJax error:', err));
                }
            }, 100);
        }
        
        function closePreview() {
            document.getElementById('previewModal').style.display = 'none';
        }
        
        function toggleYearDropdown() {
            const source = document.getElementById('questionSource').value;
            const yearGroup = document.getElementById('yearGroup');
            const schoolGroup = document.getElementById('schoolGroup');
            
            if (source === 'TYS' || source === 'Prelim') {
                yearGroup.style.display = 'block';
            } else {
                yearGroup.style.display = 'none';
                document.getElementById('questionYear').value = '';
            }
            
            // Show school field only for Prelim
            if (source === 'Prelim') {
                schoolGroup.style.display = 'block';
            } else {
                schoolGroup.style.display = 'none';
                document.getElementById('questionSchool').value = '';
            }
        }
        
        document.getElementById('questionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const optionsText = document.getElementById('questionOptions').value.trim();
            const options = optionsText.split('\n').filter(opt => opt.trim() !== '');
            
            if (options.length < 2) {
                alert('Please provide at least 2 options.');
                return;
            }
            
            const source = document.getElementById('questionSource').value;
            const year = document.getElementById('questionYear').value;
            const school = document.getElementById('questionSchool').value.trim();
            
            // Validate year if source is TYS or Prelim
            if ((source === 'TYS' || source === 'Prelim') && !year) {
                alert('Please select a year for ' + source);
                return;
            }
            
            // Validate school if source is Prelim
            if (source === 'Prelim' && !school) {
                alert('School name is required for Prelim questions');
                return;
            }
            
            // Handle image upload
            let imageUrl = null;
            const imageFile = document.getElementById('questionImage').files[0];
            
            if (imageFile) {
                try {
                    // Show uploading message
                    const submitBtn = this.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Uploading image...';
                    
                    // Upload to Supabase Storage
                    const fileExt = imageFile.name.split('.').pop();
                    const fileName = `${Date.now()}_${Math.random().toString(36).substring(7)}.${fileExt}`;
                    const filePath = `question-images/${fileName}`;
                    
                    const { data: uploadData, error: uploadError } = await supabaseClient.storage
                        .from('questions')
                        .upload(filePath, imageFile);
                    
                    if (uploadError) throw uploadError;
                    
                    // Get public URL
                    const { data: urlData } = supabaseClient.storage
                        .from('questions')
                        .getPublicUrl(filePath);
                    
                    imageUrl = urlData.publicUrl;
                    
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                } catch (error) {
                    console.error('Error uploading image:', error);
                    alert('Error uploading image: ' + error.message + '\n\nPlease make sure the "questions" storage bucket exists in Supabase.');
                    return;
                }
            }
            
            const question = {
                text: document.getElementById('questionText').value.trim(),
                topic: document.getElementById('questionTopic').value,
                difficulty: document.getElementById('questionDifficulty').value,
                options: options,
                correctAnswer: document.getElementById('correctAnswer').value,
                explanation: document.getElementById('questionExplanation').value.trim(),
                videoUrl: document.getElementById('videoUrl').value.trim(),
                source: source || null,
                sourceYear: year ? parseInt(year) : null,
                school: school || null,
                imageUrl: imageUrl !== null ? imageUrl : (editingQuestionId ? editingImageUrl : null)
            };
            
            if (editingQuestionId) {
                updateQuestionInSupabase(editingQuestionId, question);
            } else {
                addQuestionToSupabase(question);
            }
        });

        // Filter handlers
        document.getElementById('filterTopic').addEventListener('change', displayQuestions);
        document.getElementById('filterDifficulty').addEventListener('change', displayQuestions);
        document.getElementById('filterSource').addEventListener('change', displayQuestions);

        // ============================================
        // DISPLAY FUNCTIONS
        // ============================================
        function displayQuestions() {
            const filterTopic = document.getElementById('filterTopic').value;
            const filterDifficulty = document.getElementById('filterDifficulty').value;
            const filterSource = document.getElementById('filterSource').value;
            
            let filtered = questionBank.filter(q => {
                const topicMatch = !filterTopic || q.topic === filterTopic;
                const difficultyMatch = !filterDifficulty || q.difficulty === filterDifficulty;
                const sourceMatch = !filterSource || q.source === filterSource;
                return topicMatch && difficultyMatch && sourceMatch;
            });
            
            const questionList = document.getElementById('questionList');
            
            if (filtered.length === 0) {
                questionList.innerHTML = `
                    <div class="empty-state">
                        <h3>No questions found</h3>
                        <p>Try adjusting your filters or add new questions.</p>
                    </div>
                `;
                return;
            }
            
            questionList.innerHTML = filtered.map(question => {
                // Build source tag if available
                let sourceTag = '';
                if (question.source) {
                    let sourceText = question.source;
                    if (question.source_year) {
                        sourceText += ` ${question.source_year}`;
                    }
                    if (question.school && question.source === 'Prelim') {
                        sourceText += ` - ${question.school}`;
                    }
                    sourceTag = `<span class="tag" style="background: var(--secondary); color: var(--white);">${sourceText}</span>`;
                }
                
                return `
                <div class="question-item">
                    <div class="question-header">
                        <div class="tag-container">
                            <span class="tag tag-topic">${escapeHtml(question.topic)}</span>
                            <span class="tag tag-difficulty ${question.difficulty.toLowerCase()}">${question.difficulty}</span>
                            ${sourceTag}
                        </div>
                        <div class="question-actions">
                            <button class="btn btn-secondary" style="padding: 0.5rem 1rem;" onclick="editQuestion(${question.id})">Edit</button>
                            <button class="btn btn-danger" style="padding: 0.5rem 1rem;" onclick="deleteQuestionFromSupabase(${question.id})">Delete</button>
                        </div>
                    </div>
                    <div class="question-text">${escapeHtml(question.text)}</div>
                    ${question.image_url ? `<div style="margin-top: 1rem;"><img src="${escapeHtml(question.image_url)}" style="max-width: 100%; max-height: 300px; border-radius: 8px; border: 1px solid rgba(0, 217, 255, 0.3);"></div>` : ''}
                    <ul class="options-list">
                        ${question.options.map((opt, idx) => `
                            <li class="${String.fromCharCode(65 + idx) === question.correct_answer ? 'correct' : ''}">
                                <strong>${String.fromCharCode(65 + idx)}:</strong> ${escapeHtml(opt)}
                                ${String.fromCharCode(65 + idx) === question.correct_answer ? '<span style="color: var(--success); margin-left: auto;">‚úì Correct</span>' : ''}
                            </li>
                        `).join('')}
                    </ul>
                    ${question.explanation ? `<div style="margin-top: 1rem; padding: 0.75rem; background: rgba(0, 0, 0, 0.3); border-radius: 6px;"><strong>Explanation:</strong> ${escapeHtml(question.explanation)}</div>` : ''}
                    ${question.video_url ? `<div style="margin-top: 1rem;"><a href="${escapeHtml(question.video_url)}" target="_blank" style="color: var(--primary);">üìπ Video Explanation</a></div>` : ''}
                </div>
            `}).join('');
            
            // Render math ‚Äî only scan the question list
            if (window.MathJax) {
                MathJax.typesetPromise([document.getElementById('questionList')]);
            }
        }

        function updateQuestionCount() {
            document.getElementById('questionCount').textContent = questionBank.length;
        }

        // ============================================
        // VIEW MANAGEMENT
        // ============================================
        function showView(viewName) {
            // Check authentication for protected views
            if (!currentUser && viewName !== 'login' && viewName !== 'signup' && viewName !== 'forgotPassword') {
                console.log('Redirecting to login - user not authenticated');
                showAuthView('login');
                return;
            }
            
            // Role-based access control
            if (currentUser) {
                // Students can only access student portal and quiz views
                if ((userRole === 'student' || userRole === 'premium_student') && viewName === 'admin') {
                    alert('Access denied. Students cannot access the teacher portal.');
                    return;
                }
                
                // Teachers can only access teacher portal (admin view) and quiz views
                if (userRole === 'teacher' && viewName === 'student') {
                    alert('Access denied. Teachers cannot access the student portal.');
                    return;
                }

                // Only admin can access analytics
                if (userRole !== 'admin' && viewName === 'analytics') {
                    alert('Access denied. Only admins can view analytics.');
                    return;
                }
                
                // Only admin can access everything (no restrictions)
            }
            
            // Show/hide Prelim filters based on role
            if (viewName === 'student') {
                const prelimSection = document.getElementById('prelimFilters');
                if (prelimSection) {
                    prelimSection.style.display = (userRole === 'premium_student' || userRole === 'admin') ? 'block' : 'none';
                }
            }

            const views = document.querySelectorAll('.view');
            views.forEach(view => view.classList.remove('active'));
            
            const targetView = document.getElementById(viewName + 'View');
            if (targetView) {
                targetView.classList.add('active');
            }
            
            // Load analytics data when navigating to analytics view
            if (viewName === 'analytics') {
                loadAnalytics();
            }
            
            updateNavigation();
            
            setTimeout(() => {
                if (window.MathJax) {
                    const activeView = document.querySelector('.view.active');
                    if (activeView) MathJax.typesetPromise([activeView]);
                }
            }, 100);
        }

        function updateNavigation() {
            const navButtons = document.getElementById('navButtons');
            const activeView = document.querySelector('.view.active');
            const viewId = activeView ? activeView.id : '';
            
            let buttons = '';
            
            // Only show navigation if user is authenticated
            if (!currentUser) {
                navButtons.innerHTML = '';
                return;
            }
            
            if (viewId === 'welcomeView') {
                buttons = `
                    <span style="margin-right: 1rem; opacity: 0.8;">${userProfile ? userProfile.full_name : ''} (${userRole === 'premium_student' ? 'Premium Student' : userRole})</span>
                    <button class="btn btn-danger" onclick="logout()">Logout</button>
                `;
            } else if (viewId === 'analyticsView') {
                buttons = `
                    <button class="btn btn-secondary" onclick="showView('welcome')">Home</button>
                    <span style="margin-right: 1rem; opacity: 0.8;">${userProfile ? userProfile.full_name : ''}</span>
                    <button class="btn btn-danger" onclick="logout()">Logout</button>
                `;
            } else if (viewId === 'adminView') {
                buttons = `
                    <button class="btn btn-secondary" onclick="showView('welcome')">Home</button>
                    <span style="margin-right: 1rem; opacity: 0.8;">${userProfile ? userProfile.full_name : ''}</span>
                    <button class="btn btn-danger" onclick="logout()">Logout</button>
                `;
            } else if (viewId === 'studentView') {
                buttons = `
                    <button class="btn btn-secondary" onclick="showView('welcome')">Home</button>
                    <span style="margin-right: 1rem; opacity: 0.8;">${userProfile ? userProfile.full_name : ''}</span>
                    <button class="btn btn-danger" onclick="logout()">Logout</button>
                `;
            } else if (viewId === 'quizView') {
                buttons = `
                    <button class="btn btn-danger" onclick="confirmExitQuiz()">Exit Quiz</button>
                `;
            } else if (viewId === 'resultsView') {
                buttons = `
                    <button class="btn btn-secondary" onclick="showView('welcome')">Home</button>
                    <button class="btn btn-danger" onclick="logout()">Logout</button>
                `;
            }
            
            navButtons.innerHTML = buttons;
        }

        function confirmExitQuiz() {
            if (confirm('Are you sure you want to exit the quiz? Your progress will be lost.')) {
                if (userRole === 'student' || userRole === 'premium_student') {
                    showView('student');
                } else {
                    showView('welcome');
                }
            }
        }
        
        function accessTeacherPortal() {
            if (userRole === 'student' || userRole === 'premium_student') {
                alert('Access denied. Students cannot access the teacher portal.');
                return;
            }
            showView('admin');
        }
        
        function accessStudentPortal() {
            if (userRole === 'teacher') {
                alert('Access denied. Teachers cannot access the student portal.\n\nTeachers can upload questions via the Teacher Portal.');
                return;
            }
            showView('student');
        }

        // ============================================
        // QUIZ FUNCTIONALITY
        // ============================================
        
        function toggleAllTopics() {
            const selectAll = document.getElementById('selectAllTopics');
            const topicCheckboxes = document.querySelectorAll('.topic-checkbox');
            
            topicCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }
        
        function startQuiz() {
            const selectedTopics = Array.from(document.querySelectorAll('.topic-checkbox:checked'))
                .map(cb => cb.value);
            const selectedDifficulties = Array.from(document.querySelectorAll('#difficultyCheckboxes input:checked'))
                .map(cb => cb.value);
            const selectedSources = Array.from(document.querySelectorAll('.source-checkbox:checked'))
                .map(cb => ({
                    source: cb.getAttribute('data-source'),
                    year: cb.getAttribute('data-year') ? parseInt(cb.getAttribute('data-year')) : null,
                    school: cb.getAttribute('data-school') || null
                }));
            const numQuestions = parseInt(document.getElementById('numQuestions').value);
            
            console.log('=== QUIZ FILTER DEBUG ===');
            console.log('Selected Topics:', selectedTopics);
            console.log('Selected Difficulties:', selectedDifficulties);
            console.log('Selected Sources:', selectedSources);
            console.log('Total questions in bank:', questionBank.length);
            
            if (selectedTopics.length === 0) {
                alert('Please select at least one topic.');
                return;
            }
            
            if (selectedDifficulties.length === 0) {
                alert('Please select at least one difficulty level.');
                return;
            }
            
            // Filter questions
            let availableQuestions = questionBank.filter(q => {
                const topicMatch = selectedTopics.includes(q.topic);
                const difficultyMatch = selectedDifficulties.includes(q.difficulty);

                // Regular students cannot access Prelim questions
                if (userRole === 'student' && q.source === 'Prelim') return false;
                
                // Source filtering logic
                let sourceMatch = true;
                if (selectedSources.length > 0) {
                    sourceMatch = selectedSources.some(s => {
                        // If no source specified in question, don't match
                        if (!q.source) {
                            console.log('Question has no source:', q.text.substring(0, 30));
                            return false;
                        }
                        
                        // Check source match
                        if (s.source !== q.source) {
                            console.log('Source mismatch:', s.source, '!==', q.source);
                            return false;
                        }
                        
                        // If year is specified in filter, check year match
                        if (s.year !== null) {
                            // Handle both number and string years
                            const questionYear = parseInt(q.source_year);
                            const filterYear = parseInt(s.year);
                            console.log('Comparing years - Question:', questionYear, 'Filter:', filterYear, 'Match:', questionYear === filterYear);
                            if (questionYear !== filterYear) return false;
                        }
                        
                        // If school is specified in filter (Prelim), check school match
                        if (s.school !== null && q.school !== s.school) return false;
                        
                        return true;
                    });
                }
                
                const matches = topicMatch && difficultyMatch && sourceMatch;
                if (matches) {
                    console.log('‚úì Question matched:', q.text.substring(0, 50), '- Source:', q.source, 'Year:', q.source_year);
                }
                
                return matches;
            });
            
            console.log('Available questions after filter:', availableQuestions.length);
            console.log('=== END DEBUG ===');
            
            if (availableQuestions.length === 0) {
                alert('No questions available with the selected criteria.');
                return;
            }
            
            if (availableQuestions.length < numQuestions) {
                alert(`Only ${availableQuestions.length} questions available. Starting quiz with ${availableQuestions.length} questions.`);
            }
            
            // Shuffle and select questions
            currentQuiz = shuffleArray(availableQuestions).slice(0, Math.min(numQuestions, availableQuestions.length));
            currentQuestionIndex = 0;
            userAnswers = new Array(currentQuiz.length).fill(null);
            
            // Reset navigation button states
            document.getElementById('prevBtn').onclick = previousQuestion;
            document.getElementById('nextBtn').onclick = nextQuestion;
            document.getElementById('quizSubmitBtn').onclick = submitQuiz;
            document.getElementById('nextBtn').textContent = 'Next Question';
            document.getElementById('quizSubmitBtn').textContent = 'Submit Quiz';
            
            showView('quiz');
            displayQuizQuestion();
        }

        function displayQuizQuestion() {
            const question = currentQuiz[currentQuestionIndex];
            
            // Debug logging
            console.log('Current question:', question);
            console.log('Options:', question.options);
            console.log('Options type:', typeof question.options);
            console.log('Is array?:', Array.isArray(question.options));
            
            // Update progress
            document.getElementById('currentQuestion').textContent = `Question ${currentQuestionIndex + 1}`;
            document.getElementById('totalQuestions').textContent = `of ${currentQuiz.length}`;
            document.getElementById('progressFill').style.width = `${((currentQuestionIndex + 1) / currentQuiz.length) * 100}%`;
            
            // Update tags
            let sourceTag = '';
            if (question.source) {
                let sourceText = question.source;
                if (question.source_year) {
                    sourceText += ` ${question.source_year}`;
                }
                if (question.school && question.source === 'Prelim') {
                    sourceText += ` - ${question.school}`;
                }
                sourceTag = `<span class="tag" style="background: var(--secondary); color: var(--white);">${sourceText}</span>`;
            }
            
            document.getElementById('quizQuestionTags').innerHTML = `
                <span class="tag tag-topic">${escapeHtml(question.topic)}</span>
                <span class="tag tag-difficulty ${question.difficulty.toLowerCase()}">${question.difficulty}</span>
                ${sourceTag}
            `;
            
            // Update question text (use innerHTML to allow LaTeX and br tags)
            document.getElementById('quizQuestionText').innerHTML = sanitizeQuestionText(question.text);
            
            // Display image if available
            const quizQuestion = document.querySelector('.quiz-question');
            let existingImage = quizQuestion.querySelector('.question-image-container');
            if (existingImage) existingImage.remove();
            
            if (question.image_url) {
                const imageContainer = document.createElement('div');
                imageContainer.className = 'question-image-container';
                imageContainer.style.cssText = 'margin: 1.5rem 0; text-align: center;';
                imageContainer.innerHTML = `<img src="${escapeHtml(question.image_url)}" style="max-width: 100%; max-height: 400px; border-radius: 12px; border: 2px solid var(--primary); box-shadow: var(--shadow-md);">`;
                document.getElementById('quizQuestionText').after(imageContainer);
            }
            
            // Update options - with safety check
            const optionsContainer = document.getElementById('quizOptions');
            
            // Make sure options is an array
            const optionsArray = Array.isArray(question.options) ? question.options : [];
            
            if (optionsArray.length === 0) {
                console.error('No options found for question!');
                optionsContainer.innerHTML = '<div style="color: red; padding: 1rem;">Error: No options available for this question. Please check the database.</div>';
                return;
            }
            
            optionsContainer.innerHTML = optionsArray.map((option, index) => {
                const letter = String.fromCharCode(65 + index);
                const isSelected = userAnswers[currentQuestionIndex] === letter;
                
                return `
                    <div class="option ${isSelected ? 'selected' : ''}" onclick="selectOption('${letter}')">
                        <div class="option-letter">${letter}</div>
                        <div class="option-text">${escapeHtml(option)}</div>
                    </div>
                `;
            }).join('');
            
            // Hide video and explanation in quiz mode
            document.getElementById('videoContainer').style.display = 'none';
            document.getElementById('explanationContainer').style.display = 'none';
            
            // Update navigation buttons
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            document.getElementById('nextBtn').style.display = currentQuestionIndex < currentQuiz.length - 1 ? 'block' : 'none';
            document.getElementById('quizSubmitBtn').style.display = currentQuestionIndex === currentQuiz.length - 1 ? 'block' : 'none';
            
            // Render math ‚Äî only scan the quiz question, not the whole page
            if (window.MathJax) {
                MathJax.typesetClear([document.getElementById('quizView')]);
                MathJax.typesetPromise([document.getElementById('quizView')]);
            }
        }

        function selectOption(letter) {
            userAnswers[currentQuestionIndex] = letter;
            displayQuizQuestion();
        }

        function nextQuestion() {
            if (currentQuestionIndex < currentQuiz.length - 1) {
                currentQuestionIndex++;
                displayQuizQuestion();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuizQuestion();
            }
        }

        function submitQuiz() {
            const unanswered = userAnswers.filter(a => a === null).length;
            if (unanswered > 0) {
                if (!confirm(`You have ${unanswered} unanswered question(s). Submit anyway?`)) {
                    return;
                }
            }
            
            // Calculate score
            let correct = 0;
            currentQuiz.forEach((question, index) => {
                if (userAnswers[index] === question.correct_answer) {
                    correct++;
                }
            });
            
            const percentage = Math.round((correct / currentQuiz.length) * 100);
            
            // Save quiz attempt to database for students
            if ((userRole === 'student' || userRole === 'premium_student') && currentUser) {
                saveQuizAttempt(correct, currentQuiz.length, percentage)
                    .catch(err => console.error('Failed to save quiz attempt (non-critical):', err));
            }
            
            // Display results
            document.getElementById('finalScore').textContent = `${percentage}%`;
            document.getElementById('resultsMessage').textContent = 
                percentage >= 90 ? 'Outstanding! You\'re a chemistry master!' :
                percentage >= 70 ? 'Great job! Keep up the good work!' :
                percentage >= 50 ? 'Good effort! Review the topics and try again.' :
                'Keep practicing! You\'ll improve with time.';
            
            // Breakdown by topic and difficulty
            const breakdown = {};
            currentQuiz.forEach((question, index) => {
                const key = `${question.topic} - ${question.difficulty}`;
                if (!breakdown[key]) {
                    breakdown[key] = { correct: 0, total: 0 };
                }
                breakdown[key].total++;
                if (userAnswers[index] === question.correct_answer) {
                    breakdown[key].correct++;
                }
            });
            
            let breakdownHtml = '<h3 style="margin-bottom: 1rem;">Performance Breakdown</h3>';
            for (const [key, stats] of Object.entries(breakdown)) {
                const pct = Math.round((stats.correct / stats.total) * 100);
                breakdownHtml += `
                    <div style="background: rgba(10, 14, 39, 0.6); padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; display: flex; justify-content: space-between;">
                        <span>${escapeHtml(key)}</span>
                        <span style="color: var(--accent);">${stats.correct}/${stats.total} (${pct}%)</span>
                    </div>
                `;
            }
            
            document.getElementById('resultsBreakdown').innerHTML = breakdownHtml;
            
            showView('results');
        }
        
        async function saveQuizAttempt(correct, total, percentage) {
            try {
                // Get unique topics and difficulties
                const topics = [...new Set(currentQuiz.map(q => q.topic))];
                const difficulties = [...new Set(currentQuiz.map(q => q.difficulty))];
                const sources = [...new Set(currentQuiz.map(q => q.source).filter(s => s))];
                
                // Insert quiz attempt
                const { data: quizData, error: quizError } = await supabaseClient
                    .from('quiz_attempts')
                    .insert([{
                        user_id: currentUser.id,
                        completed_at: new Date().toISOString(),
                        score: percentage,
                        total_questions: total,
                        correct_answers: correct,
                        topics: topics,
                        difficulties: difficulties,
                        source: sources.length > 0 ? sources[0] : null
                    }])
                    .select()
                    .single();
                
                if (quizError) throw quizError;
                
                // Insert individual question responses
                const responses = userAnswers.map((answer, index) => ({
                    quiz_attempt_id: quizData.id,
                    question_id: currentQuiz[index].id,
                    user_id: currentUser.id,
                    user_answer: answer,
                    is_correct: answer === currentQuiz[index].correct_answer
                }));
                
                const { error: responsesError } = await supabaseClient
                    .from('question_responses')
                    .insert(responses);
                
                if (responsesError) throw responsesError;
                
                console.log('Quiz attempt saved successfully');
                
            } catch (error) {
                console.error('Error saving quiz attempt:', error);
                // Non-critical error - don't interrupt user experience
            }
        }

        function reviewQuiz() {
            currentQuestionIndex = 0;
            showView('quiz');
            displayReviewQuestion();
        }

        function displayReviewQuestion() {
            const question = currentQuiz[currentQuestionIndex];
            const userAnswer = userAnswers[currentQuestionIndex];
            const isCorrect = userAnswer === question.correct_answer;
            
            // Update progress
            document.getElementById('currentQuestion').textContent = `Question ${currentQuestionIndex + 1}`;
            document.getElementById('totalQuestions').textContent = `of ${currentQuiz.length}`;
            document.getElementById('progressFill').style.width = `${((currentQuestionIndex + 1) / currentQuiz.length) * 100}%`;
            
            // Update tags
            let sourceTag = '';
            if (question.source) {
                let sourceText = question.source;
                if (question.source_year) {
                    sourceText += ` ${question.source_year}`;
                }
                if (question.school && question.source === 'Prelim') {
                    sourceText += ` - ${question.school}`;
                }
                sourceTag = `<span class="tag" style="background: var(--secondary); color: var(--white);">${sourceText}</span>`;
            }
            
            document.getElementById('quizQuestionTags').innerHTML = `
                <span class="tag tag-topic">${escapeHtml(question.topic)}</span>
                <span class="tag tag-difficulty ${question.difficulty.toLowerCase()}">${question.difficulty}</span>
                ${sourceTag}
                <span class="tag" style="background: ${isCorrect ? 'var(--success)' : 'var(--danger)'}; color: ${isCorrect ? 'var(--dark)' : 'var(--white)'};">
                    ${isCorrect ? '‚úì Correct' : '‚úó Incorrect'}
                </span>
            `;
            
            // Update question text (use innerHTML for LaTeX and br tags)
            document.getElementById('quizQuestionText').innerHTML = sanitizeQuestionText(question.text);
            
            // Display image if available
            const quizQuestion = document.querySelector('.quiz-question');
            let existingImage = quizQuestion.querySelector('.question-image-container');
            if (existingImage) existingImage.remove();
            
            if (question.image_url) {
                const imageContainer = document.createElement('div');
                imageContainer.className = 'question-image-container';
                imageContainer.style.cssText = 'margin: 1.5rem 0; text-align: center;';
                imageContainer.innerHTML = `<img src="${escapeHtml(question.image_url)}" style="max-width: 100%; max-height: 400px; border-radius: 12px; border: 2px solid var(--primary); box-shadow: var(--shadow-md);">`;
                document.getElementById('quizQuestionText').after(imageContainer);
            }
            
            // Update options with correct/incorrect indicators
            const optionsContainer = document.getElementById('quizOptions');
            optionsContainer.innerHTML = question.options.map((option, index) => {
                const letter = String.fromCharCode(65 + index);
                const isUserAnswer = userAnswer === letter;
                const isCorrectAnswer = question.correct_answer === letter;
                
                let className = 'option';
                if (isCorrectAnswer) className += ' correct';
                else if (isUserAnswer && !isCorrect) className += ' incorrect';
                
                return `
                    <div class="${className}">
                        <div class="option-letter">${letter}</div>
                        <div class="option-text">${escapeHtml(option)}</div>
                        ${isUserAnswer ? '<span style="margin-left: auto;">Your answer</span>' : ''}
                        ${isCorrectAnswer ? '<span style="margin-left: auto; color: var(--success);">‚úì Correct</span>' : ''}
                    </div>
                `;
            }).join('');
            
            // Show explanation
            if (question.explanation) {
                document.getElementById('explanationContainer').style.display = 'block';
                document.getElementById('quizExplanation').innerHTML = sanitizeQuestionText(question.explanation);
            }
            
            // Show video if available
            if (question.video_url) {
                document.getElementById('videoContainer').style.display = 'block';
                const videoPreview = document.getElementById('quizVideoPreview');
                
                let embedUrl = question.video_url;
                if (embedUrl.includes('youtube.com/watch')) {
                    const videoId = embedUrl.split('v=')[1]?.split('&')[0];
                    embedUrl = `https://www.youtube.com/embed/${videoId}`;
                } else if (embedUrl.includes('youtu.be')) {
                    const videoId = embedUrl.split('youtu.be/')[1]?.split('?')[0];
                    embedUrl = `https://www.youtube.com/embed/${videoId}`;
                }
                
                videoPreview.innerHTML = `<iframe width="100%" height="400" src="${embedUrl}" frameborder="0" allowfullscreen></iframe>`;
            }
            
            // Update navigation
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            document.getElementById('prevBtn').onclick = () => {
                if (currentQuestionIndex > 0) {
                    currentQuestionIndex--;
                    displayReviewQuestion();
                }
            };
            
            if (currentQuestionIndex < currentQuiz.length - 1) {
                document.getElementById('nextBtn').style.display = 'block';
                document.getElementById('nextBtn').textContent = 'Next Question';
                document.getElementById('nextBtn').onclick = () => {
                    currentQuestionIndex++;
                    displayReviewQuestion();
                };
                document.getElementById('quizSubmitBtn').style.display = 'none';
            } else {
                document.getElementById('nextBtn').style.display = 'none';
                document.getElementById('quizSubmitBtn').style.display = 'block';
                document.getElementById('quizSubmitBtn').textContent = 'Back to Results';
                document.getElementById('quizSubmitBtn').onclick = () => showView('results');
            }
            
            // Render math ‚Äî only scan the quiz question, not the whole page
            if (window.MathJax) {
                MathJax.typesetClear([document.getElementById('quizView')]);
                MathJax.typesetPromise([document.getElementById('quizView')]);
            }
        }
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function sanitizeQuestionText(text) {
            // Allow <br> tags and LaTeX delimiters, escape everything else
            // First, temporarily replace br tags and LaTeX
            const brPlaceholder = '___BR___';
            const latexInlinePlaceholder = '___LATEXINLINE___';
            const latexDisplayPlaceholder = '___LATEXDISPLAY___';
            
            let processed = text;
            
            // Store br tags
            const brMatches = [];
            processed = processed.replace(/<br\s*\/?>/gi, () => {
                brMatches.push('<br>');
                return brPlaceholder;
            });
            
            // Store inline LaTeX \(...\)
            const latexInlineMatches = [];
            processed = processed.replace(/\\\(([\s\S]*?)\\\)/g, (match) => {
                latexInlineMatches.push(match);
                return latexInlinePlaceholder;
            });
            
            // Store display LaTeX \[...\]
            const latexDisplayMatches = [];
            processed = processed.replace(/\\\[([\s\S]*?)\\\]/g, (match) => {
                latexDisplayMatches.push(match);
                return latexDisplayPlaceholder;
            });
            
            // Escape HTML
            const div = document.createElement('div');
            div.textContent = processed;
            processed = div.innerHTML;
            
            // Restore br tags
            brMatches.forEach(() => {
                processed = processed.replace(brPlaceholder, '<br>');
            });
            
            // Restore inline LaTeX
            latexInlineMatches.forEach((latex) => {
                processed = processed.replace(latexInlinePlaceholder, latex);
            });
            
            // Restore display LaTeX
            latexDisplayMatches.forEach((latex) => {
                processed = processed.replace(latexDisplayPlaceholder, latex);
            });
            
            return processed;
        }

        // ============================================
        // PDF WORKSHEET GENERATOR
        // ============================================

        let pdfType = 'student'; // 'student' or 'tutor'

        function openPdfModal() {
            if (userRole !== 'admin') {
                alert('Access denied. Only admins can generate worksheets.');
                return;
            }
            document.getElementById('pdfModal').style.display = 'block';
            // Update availability count if topic already selected
            checkPdfAvailability();
        }

        function closePdfModal() {
            document.getElementById('pdfModal').style.display = 'none';
        }

        function setPdfType(type) {
            pdfType = type;
            document.getElementById('pdfTypeStudent').classList.toggle('active', type === 'student');
            document.getElementById('pdfTypeTutor').classList.toggle('active', type === 'tutor');
        }

        function getPdfFilteredQuestions() {
            const topic = document.getElementById('pdfTopic').value;
            const selectedDiffs = Array.from(document.querySelectorAll('.pdf-diff-cb:checked')).map(cb => cb.value);
            if (!topic || selectedDiffs.length === 0) return [];
            return questionBank.filter(q => q.topic === topic && selectedDiffs.includes(q.difficulty));
        }

        function checkPdfAvailability() {
            const topic = document.getElementById('pdfTopic').value;
            if (!topic) {
                document.getElementById('pdfAvailableCount').style.display = 'none';
                return;
            }
            const available = getPdfFilteredQuestions();
            const countEl = document.getElementById('pdfAvailableCount');
            countEl.style.display = 'inline-block';
            countEl.textContent = `${available.length} question${available.length !== 1 ? 's' : ''} available with selected filters`;

            // Clamp max questions to what's available
            const numInput = document.getElementById('pdfNumQuestions');
            if (parseInt(numInput.value) > available.length) {
                numInput.value = available.length;
            }
            numInput.max = available.length;
        }

        // Auto-update count when filters change
        document.addEventListener('change', function(e) {
            if (e.target.id === 'pdfTopic' || e.target.classList.contains('pdf-diff-cb')) {
                checkPdfAvailability();
            }
        });

        function generateAndPrintPdf() {
            if (userRole !== 'admin') {
                alert('Access denied. Only admins can generate worksheets.');
                return;
            }
            const topic = document.getElementById('pdfTopic').value;
            if (!topic) { alert('Please select a topic first.'); return; }

            const selectedDiffs = Array.from(document.querySelectorAll('.pdf-diff-cb:checked')).map(cb => cb.value);
            if (selectedDiffs.length === 0) { alert('Please select at least one difficulty level.'); return; }

            const numRequested = parseInt(document.getElementById('pdfNumQuestions').value) || 10;
            const available = getPdfFilteredQuestions();

            if (available.length === 0) {
                alert('No questions found for the selected topic and difficulty. Please adjust your filters.');
                return;
            }

            const count = Math.min(numRequested, available.length);
            if (numRequested > available.length) {
                alert(`Only ${available.length} questions available. Generating ${available.length} questions.`);
            }

            // Shuffle and select
            const selected = shuffleArray(available).slice(0, count);
            const customTitle = document.getElementById('pdfTitle').value.trim();

            // Build print HTML
            const printHtml = buildPrintHtml(selected, topic, selectedDiffs, customTitle, pdfType);

            // Inject into print area and trigger print
            const printArea = document.getElementById('pdfPrintArea');
            printArea.innerHTML = printHtml;
            printArea.style.display = 'block';

            // Wait for MathJax to render, then print
            const doPrint = () => {
                window.print();
                // After print dialog closes, hide the print area
                setTimeout(() => {
                    printArea.style.display = 'none';
                    printArea.innerHTML = '';
                }, 1000);
            };

            if (window.MathJax) {
                MathJax.typesetPromise([printArea]).then(doPrint).catch(doPrint);
            } else {
                doPrint();
            }
        }

        function buildPrintHtml(questions, topic, difficulties, customTitle, type) {
            const isTutor = type === 'tutor';
            const dateStr = new Date().toLocaleDateString('en-SG', { day: 'numeric', month: 'long', year: 'numeric' });
            const diffLabel = difficulties.length === 3 ? 'All Difficulties' : difficulties.join(' / ');
            const worksheetTitle = customTitle || `${topic} ‚Äî ${isTutor ? 'Answer Key' : 'Practice Worksheet'}`;
            const versionLabel = isTutor ? 'TUTOR ANSWER KEY' : 'STUDENT WORKSHEET';

            let html = `
            <style>
                @page { margin: 18mm 18mm 18mm 18mm; }
                @page { @bottom-center { content: counter(page) " / " counter(pages); font-family: Arial, sans-serif; font-size: 9pt; color: #777; } }
                * { box-sizing: border-box; margin: 0; padding: 0; }
                body { font-family: Arial, sans-serif; font-size: 11pt; color: #000; background: #fff; }

                .ws-header { border-bottom: 2.5px solid #000; padding-bottom: 8px; margin-bottom: 18px; }
                .ws-title { font-size: 16pt; font-weight: bold; margin-bottom: 4px; }
                .ws-meta { font-size: 9pt; color: #444; display: flex; justify-content: space-between; }
                .ws-version { font-size: 8.5pt; font-weight: bold; letter-spacing: 1px;
                    ${isTutor ? 'color:#fff; background:#000; padding:2px 8px; border-radius:3px;' : 'border:1px solid #000; padding:2px 8px; border-radius:3px;'} }

                .name-line { margin-bottom: 18px; font-size: 10pt; }
                .name-line span { display:inline-block; border-bottom: 1px solid #000; width: 200px; margin: 0 6px; }

                .question-block { margin-bottom: 22px; page-break-inside: avoid; }
                .question-num { font-weight: bold; font-size: 10.5pt; margin-bottom: 5px; }
                .question-tags { font-size: 8pt; color: #555; margin-bottom: 5px; }
                .question-text { font-size: 10.5pt; line-height: 1.55; margin-bottom: 8px; }
                .question-img { margin: 8px 0; text-align: center; }
                .question-img img { max-width: 100%; max-height: 220px; border: 1px solid #ccc; }

                .options { margin-left: 4px; }
                .option-row { display: flex; align-items: flex-start; gap: 8px; margin-bottom: 5px; font-size: 10.5pt; line-height: 1.4; }
                .option-letter { font-weight: bold; min-width: 20px; }
                .option-row.correct-ans .option-letter { text-decoration: underline; }
                .option-row.correct-ans .option-text { font-weight: bold; }
                .correct-marker { font-size: 9pt; color: #000; margin-left: 6px; font-weight: bold; }

                .answer-box { margin-top: 8px; padding: 7px 10px; border: 1px solid #888;
                    border-radius: 4px; font-size: 10pt; background: #f9f9f9; }
                .answer-box .ans-label { font-weight: bold; font-size: 9pt; text-transform: uppercase;
                    letter-spacing: 0.5px; margin-bottom: 3px; }
                .answer-box .correct-letter { font-size: 13pt; font-weight: bold; }
                .explanation-text { font-size: 9.5pt; line-height: 1.5; margin-top: 4px; color: #222; }

                .answer-summary { margin-top: 28px; padding-top: 12px; border-top: 1.5px solid #000; page-break-inside: avoid; }
                .answer-summary h3 { font-size: 11pt; margin-bottom: 10px; }
                .ans-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 5px; }
                .ans-cell { border: 1px solid #aaa; border-radius: 3px; text-align: center; font-size: 9pt; padding: 4px 2px; }
                .ans-cell .q-num { font-weight: bold; font-size: 8pt; border-bottom: 1px solid #ccc; margin-bottom: 2px; }
                .ans-cell .q-ans { font-weight: bold; font-size: 10pt; }

                .ws-footer { margin-top: 20px; padding-top: 8px; border-top: 1px solid #ccc;
                    font-size: 8pt; color: #777; display: flex; justify-content: space-between; }
            </style>

            <div class="ws-header">
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div class="ws-title">${escapeHtml(worksheetTitle)}</div>
                    <div class="ws-version">${versionLabel}</div>
                </div>
                <div class="ws-meta">
                    <span>Topic: <strong>${escapeHtml(topic)}</strong> &nbsp;|&nbsp; Difficulty: ${escapeHtml(diffLabel)} &nbsp;|&nbsp; Questions: ${questions.length}</span>

                </div>
            </div>
            `;

            // Student name line (only on student version)
            if (!isTutor) {
                html += `
                <div class="name-line">
                    Name: <span>&nbsp;</span> &nbsp;&nbsp;&nbsp; Class: <span style="width:120px;">&nbsp;</span> &nbsp;&nbsp;&nbsp; Date: <span style="width:120px;">&nbsp;</span>
                </div>`;
            }

            // Questions
            questions.forEach((q, idx) => {
                const options = Array.isArray(q.options) ? q.options : [];
                const diffTag = q.difficulty || '';
                const sourceTag = q.source ? ` | ${q.source}${q.source_year ? ' ' + q.source_year : ''}` : '';

                html += `<div class="question-block">`;
                html += `<div class="question-num">Question ${idx + 1}</div>`;
                html += `<div class="question-tags">${escapeHtml(diffTag)}${escapeHtml(sourceTag)}</div>`;
                html += `<div class="question-text">${sanitizeQuestionText(q.text)}</div>`;

                if (q.image_url) {
                    html += `<div class="question-img"><img src="${escapeHtml(q.image_url)}" alt="Question diagram"></div>`;
                }

                html += `<div class="options">`;
                options.forEach((opt, oi) => {
                    const letter = String.fromCharCode(65 + oi);
                    const isCorrect = isTutor && letter === q.correct_answer;
                    html += `
                        <div class="option-row ${isCorrect ? 'correct-ans' : ''}">
                            <span class="option-letter">${letter}.</span>
                            <span class="option-text">${sanitizeQuestionText(opt)}</span>
                            ${isCorrect ? '' : ''}
                        </div>`;
                });
                html += `</div>`;

                // Tutor: show answer box with explanation
                if (isTutor) {
                    html += `<div class="answer-box">`;
                    html += `<div class="ans-label">Correct Answer: <span class="correct-letter">${escapeHtml(q.correct_answer)}</span></div>`;
                    if (q.explanation) {
                        html += `<div class="explanation-text">${sanitizeQuestionText(q.explanation)}</div>`;
                    }
                    html += `</div>`;
                }

                html += `</div>`; // end question-block
            });

            // Answer summary grid for student version
            if (!isTutor) {
                html += `
                <div class="answer-summary">
                    <h3>Answers</h3>
                    <div class="ans-grid">
                        ${questions.map((q, i) => `
                            <div class="ans-cell">
                                <div class="q-num">${i + 1}</div>
                                <div class="q-ans" style="color: transparent; user-select:none;">.</div>
                            </div>`).join('')}
                    </div>
                </div>`;
            }
            // (no answer key summary for tutor version)

            // Footer
            html += `
            <div class="ws-footer">
                <span>KhemBank ‚Äî Mr Khemistry Tuition Centre</span>
                <span>${isTutor ? 'CONFIDENTIAL ‚Äî TUTOR USE ONLY' : 'A-Level H2 Chemistry'}</span>
            </div>`;

            return html;
        }

        // ============================================
        // EDIT QUESTION FUNCTIONALITY
        // ============================================

        let editingQuestionId = null;
        let editingImageUrl = null; // track existing image during edit

        function editQuestion(id) {
            const q = questionBank.find(q => q.id === id);
            if (!q) { alert('Question not found.'); return; }

            editingQuestionId = id;
            editingImageUrl = q.image_url || null;

            // Pre-fill all fields
            document.getElementById('questionText').value = q.text || '';
            document.getElementById('questionTopic').value = q.topic || '';
            document.getElementById('questionDifficulty').value = q.difficulty || '';
            document.getElementById('questionSource').value = q.source || '';
            toggleYearDropdown(); // show/hide year & school fields
            document.getElementById('questionYear').value = q.source_year || '';
            document.getElementById('questionSchool').value = q.school || '';
            document.getElementById('questionOptions').value = (q.options || []).join('\n');
            document.getElementById('correctAnswer').value = q.correct_answer || '';
            document.getElementById('questionExplanation').value = q.explanation || '';
            document.getElementById('videoUrl').value = q.video_url || '';

            // Show existing image if any
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('questionImage').value = '';
            if (q.image_url) {
                document.getElementById('existingImg').src = q.image_url;
                document.getElementById('existingImagePreview').style.display = 'block';
            } else {
                document.getElementById('existingImagePreview').style.display = 'none';
            }

            // Update UI to edit mode
            document.getElementById('formPanelTitle').textContent = 'Edit Question';
            document.getElementById('submitBtn').textContent = 'Save Changes';
            document.getElementById('cancelEditBtn').style.display = 'block';

            // Scroll to top of form
            document.getElementById('adminView').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEdit() {
            editingQuestionId = null;
            editingImageUrl = null;
            document.getElementById('questionForm').reset();
            document.getElementById('yearGroup').style.display = 'none';
            document.getElementById('schoolGroup').style.display = 'none';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('existingImagePreview').style.display = 'none';
            document.getElementById('formPanelTitle').textContent = 'Upload Question';
            document.getElementById('submitBtn').textContent = 'Upload Question';
            document.getElementById('cancelEditBtn').style.display = 'none';
        }

        function removeExistingImage() {
            editingImageUrl = null;
            document.getElementById('existingImagePreview').style.display = 'none';
        }

        async function updateQuestionInSupabase(id, question) {
            try {
                const { error } = await supabaseClient
                    .from('questions')
                    .update({
                        text: question.text,
                        topic: question.topic,
                        difficulty: question.difficulty,
                        options: question.options,
                        correct_answer: question.correctAnswer,
                        explanation: question.explanation,
                        video_url: question.videoUrl,
                        source: question.source,
                        source_year: question.sourceYear,
                        school: question.school,
                        image_url: question.imageUrl
                    })
                    .eq('id', id);

                if (error) throw error;

                alert('Question updated successfully!');
                cancelEdit();
                loadQuestionsFromSupabase();
            } catch (error) {
                console.error('Error updating question:', error);
                alert('Error updating question: ' + error.message);
            }
        }

        // ============================================
        // ============================================

        let analyticsData = { students: [], attempts: [], responses: [] };

        async function loadAnalytics() {
            if (userRole !== 'admin') return;

            // Reset containers
            document.getElementById('studentTableContainer').innerHTML = '<div class="empty-state"><h3>Loading...</h3></div>';
            document.getElementById('topicChartContainer').innerHTML = '<div class="empty-state"><h3>Loading...</h3></div>';
            ['statTotalStudents','statTotalQuizzes','statAvgScore','statWeakestTopic'].forEach(id => {
                document.getElementById(id).textContent = '‚Äî';
            });

            try {
                // 1. Load all students
                const { data: students, error: sErr } = await supabaseClient
                    .from('user_profiles')
                    .select('id, full_name, email, created_at, role')
                    .in('role', ['student', 'premium_student'])
                    .order('full_name');
                if (sErr) throw sErr;

                // 2. Load all quiz attempts
                const { data: attempts, error: aErr } = await supabaseClient
                    .from('quiz_attempts')
                    .select('*')
                    .order('completed_at', { ascending: false });
                if (aErr) throw aErr;

                // 3. Load all question responses with question topic info
                const { data: responses, error: rErr } = await supabaseClient
                    .from('question_responses')
                    .select('user_id, question_id, is_correct, quiz_attempt_id');
                if (rErr) throw rErr;

                // 4. Load question topics for responses
                const questionIds = [...new Set(responses.map(r => r.question_id))];
                let questionTopics = {};
                if (questionIds.length > 0) {
                    const { data: questions } = await supabaseClient
                        .from('questions')
                        .select('id, topic')
                        .in('id', questionIds);
                    (questions || []).forEach(q => { questionTopics[q.id] = q.topic; });
                }

                analyticsData = { students: students || [], attempts: attempts || [], responses: responses || [], questionTopics };

                renderAnalyticsSummary();
                renderStudentTable();
                renderTopicChart();

            } catch (err) {
                console.error('Analytics load error:', err);
                document.getElementById('studentTableContainer').innerHTML = `<div class="empty-state"><h3>Error loading data</h3><p>${err.message}</p></div>`;
            }
        }

        function renderAnalyticsSummary() {
            const { students, attempts } = analyticsData;

            document.getElementById('statTotalStudents').textContent = students.length;
            document.getElementById('statTotalQuizzes').textContent = attempts.length;

            const avgScore = attempts.length > 0
                ? Math.round(attempts.reduce((sum, a) => sum + (a.score || 0), 0) / attempts.length)
                : 0;
            document.getElementById('statAvgScore').textContent = attempts.length > 0 ? avgScore + '%' : 'N/A';

            // Find weakest topic from responses
            const topicStats = computeTopicStats();
            let weakest = 'N/A';
            let lowestPct = 101;
            for (const [topic, stats] of Object.entries(topicStats)) {
                if (stats.total >= 3) {
                    const pct = Math.round((stats.correct / stats.total) * 100);
                    if (pct < lowestPct) { lowestPct = pct; weakest = topic; }
                }
            }
            const weakestEl = document.getElementById('statWeakestTopic');
            weakestEl.textContent = weakest === 'N/A' ? 'N/A' : weakest;
            weakestEl.style.fontSize = weakest.length > 12 ? '1.2rem' : '';
        }

        function computeTopicStats(userId = null) {
            const { responses, questionTopics } = analyticsData;
            const stats = {};
            responses
                .filter(r => userId === null || r.user_id === userId)
                .forEach(r => {
                    const topic = questionTopics[r.question_id] || 'Unknown';
                    if (!stats[topic]) stats[topic] = { correct: 0, total: 0 };
                    stats[topic].total++;
                    if (r.is_correct) stats[topic].correct++;
                });
            return stats;
        }

        function renderStudentTable() {
            const { students, attempts } = analyticsData;

            if (students.length === 0) {
                document.getElementById('studentTableContainer').innerHTML =
                    '<div class="empty-state"><h3>No students registered yet</h3><p>Students will appear here once they sign up.</p></div>';
                return;
            }

            // Build per-student summary
            const studentSummaries = students.map(s => {
                const studentAttempts = attempts.filter(a => a.user_id === s.id);
                const avgScore = studentAttempts.length > 0
                    ? Math.round(studentAttempts.reduce((sum, a) => sum + (a.score || 0), 0) / studentAttempts.length)
                    : null;
                const lastAttempt = studentAttempts.length > 0 ? studentAttempts[0].completed_at : null;
                return { ...s, quizCount: studentAttempts.length, avgScore, lastAttempt };
            });

            // Sort by name
            studentSummaries.sort((a, b) => a.full_name.localeCompare(b.full_name));

            let html = `
                <div class="student-row header-row">
                    <div>Student</div>
                    <div>Quizzes</div>
                    <div>Avg Score</div>
                    <div>Last Active</div>
                    <div>Action</div>
                </div>
            `;

            studentSummaries.forEach(s => {
                const scoreBadgeClass = s.avgScore === null ? '' :
                    s.avgScore >= 70 ? 'score-high' :
                    s.avgScore >= 50 ? 'score-mid' : 'score-low';
                const scoreText = s.avgScore === null ? '<span style="opacity:0.5">No quizzes</span>'
                    : `<span class="score-badge ${scoreBadgeClass}">${s.avgScore}%</span>`;
                const lastActive = s.lastAttempt
                    ? new Date(s.lastAttempt).toLocaleDateString('en-SG', { day: 'numeric', month: 'short', year: 'numeric' })
                    : '<span style="opacity:0.5">‚Äî</span>';
                const isPremium = s.role === 'premium_student';
                const roleBadge = isPremium
                    ? `<span style="background:var(--accent); color:var(--dark); font-size:0.7rem; font-weight:700; padding:0.15rem 0.5rem; border-radius:10px;">PREMIUM</span>`
                    : `<span style="background:rgba(0,217,255,0.15); color:var(--primary); font-size:0.7rem; font-weight:700; padding:0.15rem 0.5rem; border-radius:10px; border:1px solid var(--primary);">STUDENT</span>`;
                const upgradeBtn = isPremium
                    ? `<button class="btn btn-secondary" style="padding:0.3rem 0.6rem; font-size:0.75rem;" onclick="togglePremium(event, '${s.id}', '${escapeHtml(s.full_name).replace(/'/g, "&#39;")}', false)">Downgrade</button>`
                    : `<button class="btn btn-success" style="padding:0.3rem 0.6rem; font-size:0.75rem;" onclick="togglePremium(event, '${s.id}', '${escapeHtml(s.full_name).replace(/'/g, "&#39;")}', true)">Upgrade</button>`;
                 html += `
                     <div class="student-row" data-uid="${s.id}" data-name="${escapeHtml(s.full_name)}">
                         <div style="cursor:pointer;" onclick="openDrilldownById('${s.id}', '${escapeHtml(s.full_name).replace(/'/g, "&#39;")}')">
                             <div style="font-weight:600; display:flex; align-items:center; gap:0.5rem;">${escapeHtml(s.full_name)} ${roleBadge}</div>
                             <div style="font-size:0.8rem; opacity:0.6;">${escapeHtml(s.email)}</div>
                         </div>
                         <div>${s.quizCount}</div>
                         <div>${scoreText}</div>
                         <div style="font-size:0.9rem;">${lastActive}</div>
                         <div style="display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap;">
                             <span style="color:var(--primary); font-size:0.9rem; cursor:pointer;" onclick="openDrilldownById('${s.id}', '${escapeHtml(s.full_name).replace(/'/g, "&#39;")}')">View ‚Üí</span>
                             ${upgradeBtn}
                             <button class="btn btn-danger" style="padding:0.3rem 0.6rem; font-size:0.75rem;" onclick="handleDeleteStudent(event, '${s.id}', '${escapeHtml(s.full_name).replace(/'/g, "&#39;")}')">Delete</button>
                         </div>
                     </div>
                 `;
            });

            document.getElementById('studentTableContainer').innerHTML = html;
        }

        async function togglePremium(event, userId, studentName, upgrade) {
            event.stopPropagation();
            const newRole = upgrade ? 'premium_student' : 'student';
            const action = upgrade ? 'upgrade' : 'downgrade';
            if (!confirm(`${upgrade ? 'Upgrade' : 'Downgrade'} "${studentName}" to ${upgrade ? 'Premium Student (TYS + Prelim access)' : 'Student (TYS only)'}?`)) return;
            try {
                const { error } = await supabaseClient
                    .from('user_profiles')
                    .update({ role: newRole })
                    .eq('id', userId);
                if (error) throw error;
                alert(`"${studentName}" has been ${action}d successfully.`);
                loadAnalytics();
            } catch (error) {
                console.error('Error updating role:', error);
                alert('Error updating student role: ' + error.message);
            }
        }

        function openDrilldownById(userId, studentName) {
            // Decode any HTML entities in the name
            const txt = document.createElement('textarea');
            txt.innerHTML = studentName;
            openDrilldown(userId, txt.value);
        }

        function handleDeleteStudent(event, userId, studentName) {
            event.stopPropagation();
            const txt = document.createElement('textarea');
            txt.innerHTML = studentName;
            deleteStudent(userId, txt.value);
        }

        async function deleteStudent(userId, studentName) {
            if (!confirm(`Are you sure you want to delete "${studentName}"?\n\nThis will permanently remove their account, login credentials, and all quiz history. This cannot be undone.`)) return;

            try {
                // Step 1: Delete quiz responses (foreign key dependency)
                await supabaseClient.from('question_responses').delete().eq('user_id', userId);
                // Step 2: Delete quiz attempts
                await supabaseClient.from('quiz_attempts').delete().eq('user_id', userId);
                // Step 3: Delete user profile
                await supabaseClient.from('user_profiles').delete().eq('id', userId);

                // Step 4: Call Edge Function to delete from Supabase Auth
                const { data: { session } } = await supabaseClient.auth.getSession();
                const response = await fetch(`${SUPABASE_URL}/functions/v1/delete-user`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}`
                    },
                    body: JSON.stringify({ userId })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Failed to delete auth account');
                }

                alert(`"${studentName}" has been fully deleted from KhemBank.\n\nNote: To also remove their login credentials, go to:\nSupabase ‚Üí Authentication ‚Üí Users ‚Üí find "${studentName}" ‚Üí Delete`);
                loadAnalytics();
            } catch (error) {
                console.error('Error deleting student:', error);
                alert('Error deleting student: ' + error.message + '\n\nNote: Their KhemBank data has been removed. To remove their login, go to:\nSupabase ‚Üí Authentication ‚Üí Users ‚Üí find the email ‚Üí Delete');
            }
        }

        function renderTopicChart() {
            const topicStats = computeTopicStats();

            if (Object.keys(topicStats).length === 0) {
                document.getElementById('topicChartContainer').innerHTML =
                    '<div class="empty-state"><h3>No quiz data yet</h3><p>Topic performance will appear once students complete quizzes.</p></div>';
                return;
            }

            // Sort by accuracy ascending (weakest first)
            const sorted = Object.entries(topicStats)
                .map(([topic, stats]) => ({
                    topic,
                    pct: Math.round((stats.correct / stats.total) * 100),
                    correct: stats.correct,
                    total: stats.total
                }))
                .sort((a, b) => a.pct - b.pct);

            let html = `<div style="margin-bottom:1rem; opacity:0.7; font-size:0.9rem;">Sorted by accuracy (weakest topics first). Requires at least 1 response per topic.</div>`;

            sorted.forEach(({ topic, pct, correct, total }) => {
                const barColor = pct >= 70 ? 'var(--success)' : pct >= 50 ? 'var(--accent)' : 'var(--danger)';
                html += `
                    <div class="topic-bar-container">
                        <div class="topic-bar-label">
                            <span>${escapeHtml(topic)}</span>
                            <span style="font-weight:700; color:${barColor}">${pct}% <span style="opacity:0.6; font-weight:400;">(${correct}/${total})</span></span>
                        </div>
                        <div class="topic-bar-track">
                            <div class="topic-bar-fill" style="width:${pct}%; background:${barColor};"></div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('topicChartContainer').innerHTML = html;
        }

        function switchAnalyticsTab(tab, btn) {
            document.querySelectorAll('.analytics-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.analytics-section').forEach(s => s.classList.remove('active'));
            btn.classList.add('active');
            const sectionId = 'analytics' + tab.charAt(0).toUpperCase() + tab.slice(1);
            document.getElementById(sectionId).classList.add('active');
        }

        function openDrilldown(userId, studentName) {
            document.getElementById('analyticsOverview').style.display = 'none';
            document.getElementById('analyticsDrilldown').style.display = 'block';

            const { attempts, responses, questionTopics } = analyticsData;

            const studentAttempts = attempts
                .filter(a => a.user_id === userId)
                .sort((a, b) => new Date(b.completed_at) - new Date(a.completed_at));

            // Topic stats for this student
            const topicStats = computeTopicStats(userId);
            const sortedTopics = Object.entries(topicStats)
                .map(([topic, stats]) => ({
                    topic,
                    pct: Math.round((stats.correct / stats.total) * 100),
                    correct: stats.correct,
                    total: stats.total
                }))
                .sort((a, b) => a.pct - b.pct);

            // Score trend for sparkline
            const scores = [...studentAttempts].reverse().map(a => a.score || 0);
            const avgScore = scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : null;
            const scoreBadgeClass = avgScore === null ? '' : avgScore >= 70 ? 'score-high' : avgScore >= 50 ? 'score-mid' : 'score-low';

            let html = `
                <div style="margin-bottom:2rem;">
                    <h2 style="font-size:1.8rem; color:var(--primary); margin-bottom:0.3rem;">${escapeHtml(studentName)}</h2>
                    <div style="display:flex; gap:2rem; margin-top:1rem; flex-wrap:wrap;">
                        <div class="stat-card" style="flex:1; min-width:140px;">
                            <div class="stat-value">${studentAttempts.length}</div>
                            <div class="stat-label">Quizzes Taken</div>
                        </div>
                        <div class="stat-card" style="flex:1; min-width:140px;">
                            <div class="stat-value">${avgScore !== null ? '<span class="score-badge ' + scoreBadgeClass + '">' + avgScore + '%</span>' : 'N/A'}</div>
                            <div class="stat-label">Average Score</div>
                        </div>
                        <div class="stat-card" style="flex:1; min-width:140px;">
                            <div class="stat-value" style="font-size:1.4rem;">${sortedTopics.length > 0 ? escapeHtml(sortedTopics[0].topic) : 'N/A'}</div>
                            <div class="stat-label">Weakest Topic</div>
                        </div>
                    </div>
                </div>
            `;

            // Score over time
            if (scores.length > 1) {
                html += `
                    <div style="margin-bottom:2rem;">
                        <h3 style="color:var(--accent); margin-bottom:1rem;">üìà Score Over Time</h3>
                        <div style="background:rgba(10,14,39,0.8); border-radius:12px; padding:1.5rem;">
                            ${renderScoreTimeline(studentAttempts)}
                        </div>
                    </div>
                `;
            }

            // Topic performance
            if (sortedTopics.length > 0) {
                html += `<div style="margin-bottom:2rem;"><h3 style="color:var(--accent); margin-bottom:1rem;">üìö Topic Performance (Weakest First)</h3>`;
                sortedTopics.forEach(({ topic, pct, correct, total }) => {
                    const barColor = pct >= 70 ? 'var(--success)' : pct >= 50 ? 'var(--accent)' : 'var(--danger)';
                    html += `
                        <div class="topic-bar-container">
                            <div class="topic-bar-label">
                                <span>${escapeHtml(topic)}</span>
                                <span style="font-weight:700; color:${barColor}">${pct}% <span style="opacity:0.6; font-weight:400;">(${correct}/${total})</span></span>
                            </div>
                            <div class="topic-bar-track">
                                <div class="topic-bar-fill" style="width:${pct}%; background:${barColor};"></div>
                            </div>
                        </div>
                    `;
                });
                html += `</div>`;
            }

            // Quiz history
            if (studentAttempts.length > 0) {
                html += `
                    <h3 style="color:var(--accent); margin-bottom:1rem;">üìã Quiz History</h3>
                    <div class="history-item" style="background:rgba(0,217,255,0.1); font-size:0.85rem; font-weight:700; color:var(--primary); text-transform:uppercase; letter-spacing:0.5px;">
                        <div>Date</div><div>Score</div><div>Questions</div><div>Topics</div>
                    </div>
                `;
                studentAttempts.forEach(a => {
                    const date = new Date(a.completed_at).toLocaleDateString('en-SG', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                    const scoreBadge = a.score >= 70 ? 'score-high' : a.score >= 50 ? 'score-mid' : 'score-low';
                    const topicsText = (a.topics || []).slice(0, 2).join(', ') + ((a.topics || []).length > 2 ? ' +' + (a.topics.length - 2) : '');
                    html += `
                        <div class="history-item">
                            <div style="font-size:0.9rem;">${date}</div>
                            <div><span class="score-badge ${scoreBadge}">${a.score}%</span></div>
                            <div>${a.correct_answers}/${a.total_questions}</div>
                            <div style="font-size:0.85rem; opacity:0.8;">${escapeHtml(topicsText || '‚Äî')}</div>
                        </div>
                    `;
                });
            } else {
                html += `<div class="empty-state"><h3>No quizzes taken yet</h3></div>`;
            }

            document.getElementById('drilldownContent').innerHTML = html;
        }

        function renderScoreTimeline(attempts) {
            // Simple horizontal dot + line chart using pure CSS/HTML
            const reversed = [...attempts].reverse(); // oldest first
            const maxScore = 100;
            const chartHeight = 120;

            let dots = '';
            reversed.forEach((a, i) => {
                const x = attempts.length === 1 ? 50 : (i / (reversed.length - 1)) * 90 + 5;
                const y = chartHeight - ((a.score / maxScore) * (chartHeight - 20)) - 10;
                const scoreColor = a.score >= 70 ? 'var(--success)' : a.score >= 50 ? 'var(--accent)' : 'var(--danger)';
                dots += `
                    <g>
                        <circle cx="${x}%" cy="${y}" r="6" fill="${scoreColor}" stroke="var(--dark)" stroke-width="2"/>
                        <text x="${x}%" y="${y - 10}" text-anchor="middle" fill="${scoreColor}" font-size="11" font-family="DM Sans">${a.score}%</text>
                    </g>
                `;
            });

            // Draw connecting lines
            let lines = '';
            for (let i = 0; i < reversed.length - 1; i++) {
                const x1 = (i / (reversed.length - 1)) * 90 + 5;
                const x2 = ((i + 1) / (reversed.length - 1)) * 90 + 5;
                const y1 = chartHeight - ((reversed[i].score / maxScore) * (chartHeight - 20)) - 10;
                const y2 = chartHeight - ((reversed[i + 1].score / maxScore) * (chartHeight - 20)) - 10;
                lines += `<line x1="${x1}%" y1="${y1}" x2="${x2}%" y2="${y2}" stroke="rgba(0,217,255,0.4)" stroke-width="2"/>`;
            }

            return `
                <svg width="100%" height="${chartHeight + 20}" style="overflow:visible;">
                    <!-- Gridlines -->
                    <line x1="0" y1="${chartHeight - ((70 / maxScore) * (chartHeight - 20)) - 10}" x2="100%" y2="${chartHeight - ((70 / maxScore) * (chartHeight - 20)) - 10}" stroke="rgba(6,255,165,0.2)" stroke-width="1" stroke-dasharray="4"/>
                    <line x1="0" y1="${chartHeight - ((50 / maxScore) * (chartHeight - 20)) - 10}" x2="100%" y2="${chartHeight - ((50 / maxScore) * (chartHeight - 20)) - 10}" stroke="rgba(255,230,109,0.2)" stroke-width="1" stroke-dasharray="4"/>
                    <text x="0" y="${chartHeight - ((70 / maxScore) * (chartHeight - 20)) - 13}" fill="rgba(6,255,165,0.5)" font-size="10">70%</text>
                    <text x="0" y="${chartHeight - ((50 / maxScore) * (chartHeight - 20)) - 13}" fill="rgba(255,230,109,0.5)" font-size="10">50%</text>
                    ${lines}
                    ${dots}
                </svg>
                <div style="text-align:center; opacity:0.5; font-size:0.8rem; margin-top:0.5rem;">‚Üê Oldest quiz &nbsp;&nbsp;&nbsp; Most recent quiz ‚Üí</div>
            `;
        }

        function closeDrilldown() {
            document.getElementById('analyticsDrilldown').style.display = 'none';
            document.getElementById('analyticsOverview').style.display = 'block';
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            updateNavigation();
        });
    </script>
</body>
</html>
