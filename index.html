<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChemBank - Chemistry Question Bank System</title>
    
    <!-- MathJax for mathematical equations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js"></script>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* Import distinctive fonts */
        @import url('https://fonts.googleapis.com/css2?family=Archivo+Black&family=DM+Sans:wght@400;500;700&family=JetBrains+Mono:wght@400;600&display=swap');
        
        :root {
            /* Chemistry-inspired color palette */
            --primary: #00D9FF;
            --primary-dark: #0099CC;
            --secondary: #FF6B35;
            --accent: #FFE66D;
            --success: #06FFA5;
            --danger: #FF006E;
            --dark: #0A0E27;
            --mid-dark: #1A1F3A;
            --light: #F0F4F8;
            --white: #FFFFFF;
            
            /* Shadows and effects */
            --shadow-sm: 0 2px 8px rgba(0, 217, 255, 0.15);
            --shadow-md: 0 4px 16px rgba(0, 217, 255, 0.2);
            --shadow-lg: 0 8px 32px rgba(0, 217, 255, 0.25);
            --glow: 0 0 20px rgba(0, 217, 255, 0.5);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--dark);
            color: var(--light);
            overflow-x: hidden;
            position: relative;
        }
        
        /* Animated background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(0, 217, 255, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(255, 107, 53, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(255, 230, 109, 0.05) 0%, transparent 70%);
            z-index: -1;
            animation: float 20s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.1) rotate(5deg); }
        }
        
        /* Header */
        header {
            background: rgba(26, 31, 58, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid var(--primary);
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-family: 'Archivo Black', sans-serif;
            font-size: 2rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -1px;
            text-transform: uppercase;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            opacity: 0.8;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--danger);
            animation: pulse 2s infinite;
        }
        
        .status-dot.connected {
            background: var(--success);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .nav-buttons {
            display: flex;
            gap: 1rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-family: 'DM Sans', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--dark);
            box-shadow: var(--shadow-md);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--glow);
        }
        
        .btn-secondary {
            background: transparent;
            color: var(--light);
            border: 2px solid var(--primary);
        }
        
        .btn-secondary:hover {
            background: var(--primary);
            color: var(--dark);
        }
        
        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }
        
        .btn-success {
            background: var(--success);
            color: var(--dark);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Main container */
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        
        /* View sections */
        .view {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .view.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Welcome screen */
        .welcome-screen {
            text-align: center;
            padding: 4rem 2rem;
        }
        
        .welcome-title {
            font-family: 'Archivo Black', sans-serif;
            font-size: 4rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
        }
        
        .welcome-subtitle {
            font-size: 1.5rem;
            color: var(--light);
            margin-bottom: 1rem;
            opacity: 0.9;
        }
        
        .welcome-info {
            font-size: 1rem;
            color: var(--accent);
            margin-bottom: 3rem;
            opacity: 0.8;
        }
        
        .portal-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-top: 3rem;
        }
        
        .portal-card {
            background: rgba(26, 31, 58, 0.6);
            backdrop-filter: blur(10px);
            border: 2px solid var(--primary);
            border-radius: 16px;
            padding: 3rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .portal-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .portal-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--glow);
        }
        
        .portal-card:hover::before {
            opacity: 0.1;
        }
        
        .portal-card h2 {
            position: relative;
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--primary);
        }
        
        .portal-card p {
            position: relative;
            font-size: 1.1rem;
            opacity: 0.9;
            line-height: 1.6;
        }
        
        /* Panels */
        .panel {
            background: rgba(26, 31, 58, 0.6);
            backdrop-filter: blur(10px);
            border: 2px solid var(--primary);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(0, 217, 255, 0.2);
        }
        
        .panel-header span {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--accent);
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            background: rgba(10, 14, 39, 0.8);
            border: 2px solid rgba(0, 217, 255, 0.3);
            border-radius: 8px;
            color: var(--light);
            font-family: 'DM Sans', sans-serif;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        /* Checkbox group */
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            transition: background 0.2s ease;
        }
        
        .checkbox-label:hover {
            background: rgba(0, 217, 255, 0.1);
        }
        
        .checkbox-label input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }
        
        /* Question list */
        .question-item {
            background: rgba(10, 14, 39, 0.8);
            border: 1px solid rgba(0, 217, 255, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }
        
        .question-item:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }
        
        .question-text {
            flex: 1;
            font-size: 1.1rem;
            line-height: 1.6;
        }
        
        .question-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .tag {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .tag-topic {
            background: var(--primary);
            color: var(--dark);
        }
        
        .tag-difficulty {
            background: var(--mid-dark);
            color: var(--light);
            border: 1px solid var(--accent);
        }
        
        .tag-difficulty.easy {
            border-color: var(--success);
            color: var(--success);
        }
        
        .tag-difficulty.medium {
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .tag-difficulty.hard {
            border-color: var(--danger);
            color: var(--danger);
        }
        
        /* Options display */
        .options-list {
            list-style: none;
            padding: 0;
        }
        
        .options-list li {
            padding: 0.5rem;
            margin-bottom: 0.25rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .options-list li.correct {
            border-left: 3px solid var(--success);
        }
        
        /* Filters */
        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        /* Quiz styles */
        .quiz-container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .quiz-progress {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1rem;
            background: rgba(26, 31, 58, 0.6);
            border-radius: 12px;
        }
        
        .progress-bar {
            flex: 1;
            height: 8px;
            background: rgba(0, 217, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.3s ease;
        }
        
        .quiz-question {
            background: rgba(26, 31, 58, 0.6);
            backdrop-filter: blur(10px);
            border: 2px solid var(--primary);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .quiz-question-text {
            font-size: 1.3rem;
            line-height: 1.8;
            margin-bottom: 2rem;
        }
        
        .options-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .option {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            background: rgba(10, 14, 39, 0.8);
            border: 2px solid rgba(0, 217, 255, 0.2);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .option:hover {
            border-color: var(--primary);
            background: rgba(0, 217, 255, 0.1);
        }
        
        .option.selected {
            border-color: var(--accent);
            background: rgba(255, 230, 109, 0.1);
        }
        
        .option.correct {
            border-color: var(--success);
            background: rgba(6, 255, 165, 0.1);
        }
        
        .option.incorrect {
            border-color: var(--danger);
            background: rgba(255, 0, 110, 0.1);
        }
        
        .option-letter {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary);
            color: var(--dark);
            border-radius: 50%;
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .option.selected .option-letter {
            background: var(--accent);
        }
        
        .option.correct .option-letter {
            background: var(--success);
        }
        
        .option.incorrect .option-letter {
            background: var(--danger);
            color: var(--white);
        }
        
        .option-text {
            flex: 1;
            font-size: 1.05rem;
        }
        
        /* Results */
        .results-panel {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }
        
        .results-score {
            font-family: 'Archivo Black', sans-serif;
            font-size: 5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 2rem 0;
        }
        
        .results-message {
            font-size: 1.5rem;
            color: var(--accent);
            margin-bottom: 2rem;
        }
        
        /* Video preview */
        .video-preview {
            margin-top: 0.5rem;
            border-radius: 8px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.5);
        }
        
        .video-preview iframe {
            width: 100%;
            height: 400px;
            border: none;
        }
        
        /* Loading state */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 39, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(0, 217, 255, 0.2);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 1rem;
            color: var(--primary);
            font-size: 1.2rem;
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem;
            opacity: 0.7;
        }
        
        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--accent);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .welcome-title {
                font-size: 2.5rem;
            }
            
            .portal-cards {
                grid-template-columns: 1fr;
            }
            
            .checkbox-group {
                grid-template-columns: 1fr;
            }
            
            .filters {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Connecting to database...</div>
    </div>

    <header>
        <div class="header-content">
            <div class="logo">ChemBank</div>
            <div class="connection-status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Connecting...</span>
            </div>
            <div class="nav-buttons" id="navButtons"></div>
        </div>
    </header>

    <div class="container">
        <!-- Welcome View -->
        <div id="welcomeView" class="view active">
            <div class="welcome-screen">
                <h1 class="welcome-title">ChemBank</h1>
                <p class="welcome-subtitle">Advanced Chemistry Question Bank System</p>
                <p class="welcome-info">üåê Cloud-powered with Supabase ‚Ä¢ Real-time synchronization ‚Ä¢ Built to scale</p>
                
                <div class="portal-cards">
                    <div class="portal-card" onclick="showView('admin')">
                        <h2>üéì Teacher Portal</h2>
                        <p>Upload questions, create quizzes, tag content by topic and difficulty, add video explanations, and manage your question bank.</p>
                    </div>
                    
                    <div class="portal-card" onclick="showView('student')">
                        <h2>üìö Student Portal</h2>
                        <p>Access quizzes, practice questions by topic and difficulty, view video explanations, and track your progress.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin View -->
        <div id="adminView" class="view">
            <div class="panel">
                <div class="panel-header">
                    <span>Upload Question</span>
                </div>
                
                <form id="questionForm">
                    <div class="form-group">
                        <label>Question Text (Supports LaTeX: Use \(...\) for inline math, \[...\] for display math)</label>
                        <textarea id="questionText" placeholder="E.g., Calculate the pH of a solution with \([H^+] = 1 \times 10^{-5}\) M" required></textarea>
                        <small style="opacity: 0.7;">LaTeX examples: \(E = mc^2\), \[H_2O + CO_2 \rightarrow H_2CO_3\]</small>
                    </div>
                    
                    <div class="form-group">
                        <label>Topic</label>
                        <select id="questionTopic" required>
                            <option value="">Select topic...</option>
                            <option value="Acid base equilibrium">Acid base equilibrium</option>
                            <option value="Atomic structure">Atomic structure</option>
                            <option value="Chemical bonding">Chemical bonding</option>
                            <option value="Chemical equilibrium">Chemical equilibrium</option>
                            <option value="Electrolysis">Electrolysis</option>
                            <option value="Electrochemical cell">Electrochemical cell</option>
                            <option value="Thermochemistry">Thermochemistry</option>
                            <option value="Thermodynamics">Thermodynamics</option>
                            <option value="Gases">Gases</option>
                            <option value="Kinetics">Kinetics</option>
                            <option value="Mole">Mole</option>
                            <option value="Periodic table">Periodic table</option>
                            <option value="Group 2">Group 2</option>
                            <option value="Group 17">Group 17</option>
                            <option value="Redox">Redox</option>
                            <option value="Transition elements">Transition elements</option>
                            <option value="Introduction to Organic">Introduction to Organic</option>
                            <option value="Alkane">Alkane</option>
                            <option value="Alkene">Alkene</option>
                            <option value="Arene">Arene</option>
                            <option value="Halogenoalkane">Halogenoalkane</option>
                            <option value="Hydroxyl Compounds">Hydroxyl Compounds</option>
                            <option value="Carbonyl Compound">Carbonyl Compound</option>
                            <option value="Carboxylic Acid">Carboxylic Acid</option>
                            <option value="Nitrogen Compound">Nitrogen Compound</option>
                            <option value="Polymers">Polymers</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Difficulty</label>
                        <select id="questionDifficulty" required>
                            <option value="">Select difficulty...</option>
                            <option value="Easy">Easy</option>
                            <option value="Medium">Medium</option>
                            <option value="Hard">Hard</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Source (Optional)</label>
                        <select id="questionSource" onchange="toggleYearDropdown()">
                            <option value="">Select source...</option>
                            <option value="TYS">TYS (Ten Year Series)</option>
                            <option value="Prelim">Prelim</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="yearGroup" style="display: none;">
                        <label>Year</label>
                        <select id="questionYear">
                            <option value="">Select year...</option>
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                            <option value="2022">2022</option>
                            <option value="2021">2021</option>
                            <option value="2020">2020</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="schoolGroup" style="display: none;">
                        <label>School <span style="color: var(--danger);">*</span></label>
                        <input type="text" id="questionSchool" placeholder="e.g., Raffles Institution, Hwa Chong, ACJC">
                        <small style="opacity: 0.7;">Required for Prelim questions</small>
                    </div>
                    
                    <div class="form-group">
                        <label>Options (One per line)</label>
                        <textarea id="questionOptions" placeholder="Option A
Option B
Option C
Option D" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Correct Answer</label>
                        <select id="correctAnswer" required>
                            <option value="">Select correct answer...</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Explanation (Optional)</label>
                        <textarea id="questionExplanation" placeholder="Provide a detailed explanation of the correct answer..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Question Image/Diagram (Optional)</label>
                        <input type="file" id="questionImage" accept="image/jpeg,image/jpg,image/png,image/gif,image/webp">
                        <small style="opacity: 0.7;">Upload diagrams, molecular structures, graphs, etc. (Max 5MB)</small>
                        <div id="imagePreview" style="margin-top: 0.5rem; display: none;">
                            <img id="previewImg" style="max-width: 300px; border-radius: 8px; border: 1px solid var(--primary);">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Video URL (Optional - YouTube link)</label>
                        <input type="url" id="videoUrl" placeholder="https://www.youtube.com/watch?v=...">
                    </div>
                    
                    <div style="display: flex; gap: 1rem;">
                        <button type="button" class="btn btn-secondary" onclick="previewQuestion()">Preview Question</button>
                        <button type="submit" class="btn btn-primary">Upload Question</button>
                    </div>
                </form>
            </div>
            
            <div class="panel">
                <div class="panel-header">
                    <span>Question Bank (<span id="questionCount">0</span> questions)</span>
                </div>
                
                <div class="filters">
                    <div class="form-group">
                        <label>Filter by Topic</label>
                        <select id="filterTopic">
                            <option value="">All Topics</option>
                            <option value="Acid base equilibrium">Acid base equilibrium</option>
                            <option value="Atomic structure">Atomic structure</option>
                            <option value="Chemical bonding">Chemical bonding</option>
                            <option value="Chemical equilibrium">Chemical equilibrium</option>
                            <option value="Electrolysis">Electrolysis</option>
                            <option value="Electrochemical cell">Electrochemical cell</option>
                            <option value="Thermochemistry">Thermochemistry</option>
                            <option value="Thermodynamics">Thermodynamics</option>
                            <option value="Gases">Gases</option>
                            <option value="Kinetics">Kinetics</option>
                            <option value="Mole">Mole</option>
                            <option value="Periodic table">Periodic table</option>
                            <option value="Group 2">Group 2</option>
                            <option value="Group 17">Group 17</option>
                            <option value="Redox">Redox</option>
                            <option value="Transition elements">Transition elements</option>
                            <option value="Introduction to Organic">Introduction to Organic</option>
                            <option value="Alkane">Alkane</option>
                            <option value="Alkene">Alkene</option>
                            <option value="Arene">Arene</option>
                            <option value="Halogenoalkane">Halogenoalkane</option>
                            <option value="Hydroxyl Compounds">Hydroxyl Compounds</option>
                            <option value="Carbonyl Compound">Carbonyl Compound</option>
                            <option value="Carboxylic Acid">Carboxylic Acid</option>
                            <option value="Nitrogen Compound">Nitrogen Compound</option>
                            <option value="Polymers">Polymers</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Filter by Difficulty</label>
                        <select id="filterDifficulty">
                            <option value="">All Difficulties</option>
                            <option value="Easy">Easy</option>
                            <option value="Medium">Medium</option>
                            <option value="Hard">Hard</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Filter by Source</label>
                        <select id="filterSource">
                            <option value="">All Sources</option>
                            <option value="TYS">TYS</option>
                            <option value="Prelim">Prelim</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                
                <div id="questionList"></div>
            </div>
        </div>

        <!-- Student View -->
        <div id="studentView" class="view">
            <div class="panel">
                <div class="panel-header">
                    <span>Select Quiz Parameters</span>
                </div>
                
                <div class="filters">
                    <div class="form-group">
                        <label>Topics (Select multiple)</label>
                        <div class="checkbox-group" id="topicCheckboxes">
                            <label class="checkbox-label" style="grid-column: 1 / -1; border-bottom: 1px solid rgba(0, 217, 255, 0.3); padding-bottom: 0.5rem; margin-bottom: 0.5rem;">
                                <input type="checkbox" id="selectAllTopics" onchange="toggleAllTopics()">
                                <span style="font-weight: 700; color: var(--accent);">‚úì All Topics</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Acid base equilibrium" class="topic-checkbox">
                                <span>Acid base equilibrium</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Atomic structure" class="topic-checkbox">
                                <span>Atomic structure</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Chemical bonding" class="topic-checkbox">
                                <span>Chemical bonding</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Chemical equilibrium" class="topic-checkbox">
                                <span>Chemical equilibrium</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Electrolysis" class="topic-checkbox">
                                <span>Electrolysis</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Electrochemical cell" class="topic-checkbox">
                                <span>Electrochemical cell</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Thermochemistry" class="topic-checkbox">
                                <span>Thermochemistry</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Thermodynamics" class="topic-checkbox">
                                <span>Thermodynamics</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Gases" class="topic-checkbox">
                                <span>Gases</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Kinetics" class="topic-checkbox">
                                <span>Kinetics</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Mole" class="topic-checkbox">
                                <span>Mole</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Periodic table" class="topic-checkbox">
                                <span>Periodic table</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Group 2" class="topic-checkbox">
                                <span>Group 2</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Group 17" class="topic-checkbox">
                                <span>Group 17</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Redox" class="topic-checkbox">
                                <span>Redox</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Transition elements" class="topic-checkbox">
                                <span>Transition elements</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Introduction to Organic" class="topic-checkbox">
                                <span>Introduction to Organic</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Alkane" class="topic-checkbox">
                                <span>Alkane</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Alkene" class="topic-checkbox">
                                <span>Alkene</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Arene" class="topic-checkbox">
                                <span>Arene</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Halogenoalkane" class="topic-checkbox">
                                <span>Halogenoalkane</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Hydroxyl Compounds" class="topic-checkbox">
                                <span>Hydroxyl Compounds</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Carbonyl Compound" class="topic-checkbox">
                                <span>Carbonyl Compound</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Carboxylic Acid" class="topic-checkbox">
                                <span>Carboxylic Acid</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Nitrogen Compound" class="topic-checkbox">
                                <span>Nitrogen Compound</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Polymers" class="topic-checkbox">
                                <span>Polymers</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Difficulties (Select multiple)</label>
                        <div class="checkbox-group" id="difficultyCheckboxes">
                            <label class="checkbox-label">
                                <input type="checkbox" value="Easy">
                                <span>Easy</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Medium">
                                <span>Medium</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Hard">
                                <span>Hard</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Sources & Years (Select multiple - Optional)</label>
                        <div id="sourceYearFilters" style="display: flex; flex-direction: column; gap: 1rem;">
                            <!-- TYS Years -->
                            <div>
                                <div style="font-weight: 600; color: var(--primary); margin-bottom: 0.5rem;">TYS (Ten Year Series)</div>
                                <div class="checkbox-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" class="source-checkbox" data-source="TYS" data-year="2025">
                                        <span>2025</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" class="source-checkbox" data-source="TYS" data-year="2024">
                                        <span>2024</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" class="source-checkbox" data-source="TYS" data-year="2023">
                                        <span>2023</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" class="source-checkbox" data-source="TYS" data-year="2022">
                                        <span>2022</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" class="source-checkbox" data-source="TYS" data-year="2021">
                                        <span>2021</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" class="source-checkbox" data-source="TYS" data-year="2020">
                                        <span>2020</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Prelim Years & Schools - will be populated dynamically -->
                            <div id="prelimFilters">
                                <div style="font-weight: 600; color: var(--primary); margin-bottom: 0.5rem;">Prelim (by School & Year)</div>
                                <div id="prelimSchoolsContainer" style="display: flex; flex-direction: column; gap: 0.5rem;">
                                    <div style="opacity: 0.7; font-size: 0.9rem;">Loading schools...</div>
                                </div>
                            </div>
                            
                            <!-- Other -->
                            <div>
                                <div style="font-weight: 600; color: var(--primary); margin-bottom: 0.5rem;">Other</div>
                                <div class="checkbox-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" class="source-checkbox" data-source="Other" data-year="">
                                        <span>Other Sources</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Number of Questions</label>
                        <input type="number" id="numQuestions" min="1" max="50" value="10">
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="startQuiz()">Start Quiz</button>
            </div>
        </div>

        <!-- Quiz View -->
        <div id="quizView" class="view">
            <div class="quiz-container">
                <div class="quiz-progress">
                    <span id="currentQuestion">Question 1</span>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <span id="totalQuestions">of 10</span>
                </div>
                
                <div class="quiz-question">
                    <div class="question-meta" style="margin-bottom: 1rem;">
                        <div class="tag-container" id="quizQuestionTags"></div>
                    </div>
                    
                    <div class="quiz-question-text" id="quizQuestionText"></div>
                    
                    <div class="options-container" id="quizOptions"></div>
                    
                    <div id="videoContainer" style="margin-top: 2rem; display: none;">
                        <label>Video Explanation</label>
                        <div class="video-preview" id="quizVideoPreview"></div>
                    </div>
                    
                    <div id="explanationContainer" style="margin-top: 2rem; display: none;">
                        <label>Explanation</label>
                        <div style="background: rgba(10, 14, 39, 0.8); padding: 1rem; border-radius: 8px; margin-top: 0.5rem;" id="quizExplanation"></div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button class="btn btn-secondary" id="prevBtn" onclick="previousQuestion()" disabled>Previous</button>
                    <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()">Next Question</button>
                    <button class="btn btn-success" id="submitBtn" onclick="submitQuiz()" style="display: none;">Submit Quiz</button>
                </div>
            </div>
        </div>

        <!-- Results View -->
        <div id="resultsView" class="view">
            <div class="panel results-panel">
                <div class="panel-header" style="justify-content: center;">
                    <span>Quiz Results</span>
                </div>
                
                <div class="results-score" id="finalScore">0%</div>
                <div class="results-message" id="resultsMessage">Great job!</div>
                
                <div style="text-align: left; margin-top: 2rem;" id="resultsBreakdown"></div>
                
                <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: center;">
                    <button class="btn btn-primary" onclick="showView('student')">Take Another Quiz</button>
                    <button class="btn btn-secondary" onclick="reviewQuiz()">Review Answers</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 14, 39, 0.95); z-index: 10000; overflow-y: auto;">
        <div style="max-width: 900px; margin: 2rem auto; padding: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2 style="color: var(--primary); font-size: 1.8rem;">Question Preview</h2>
                <button class="btn btn-danger" onclick="closePreview()">Close Preview</button>
            </div>
            
            <div class="quiz-question" id="previewContent">
                <!-- Preview content will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // SUPABASE CONFIGURATION
        // ============================================
        
        const SUPABASE_URL = 'https://fvjqsohhitpnkvfirosc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ2anFzb2hoaXRwbmt2Zmlyb3NjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2MDI5OTUsImV4cCI6MjA4NjE3ODk5NX0.EysWH7XML4y-ezkoc0NJ_IYExFA4kvtBpx2DrqylgCU';
        
        // Initialize Supabase client
        const { createClient } = supabase;
        let supabaseClient;
        let isConnected = false;

        try {
            supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            testConnection();
        } catch (error) {
            console.error('Supabase initialization error:', error);
            alert('Error connecting to database. Please check your Supabase configuration.');
            document.getElementById('loadingOverlay').style.display = 'none';
        }
        
        // Image preview handler
        document.addEventListener('DOMContentLoaded', () => {
            const imageInput = document.getElementById('questionImage');
            if (imageInput) {
                imageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        // Check file size (5MB limit)
                        if (file.size > 5 * 1024 * 1024) {
                            alert('Image size must be less than 5MB');
                            this.value = '';
                            return;
                        }
                        
                        // Preview image
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            document.getElementById('previewImg').src = e.target.result;
                            document.getElementById('imagePreview').style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    } else {
                        document.getElementById('imagePreview').style.display = 'none';
                    }
                });
            }
        });

        async function testConnection() {
            const timeout = setTimeout(() => {
                console.error('Connection timeout');
                isConnected = false;
                updateConnectionStatus(false);
                document.getElementById('loadingOverlay').style.display = 'none';
                alert('Connection timeout. Please check:\n1. Your internet connection\n2. Supabase project is running\n3. Credentials are correct');
            }, 10000); // 10 second timeout
            
            try {
                const { data, error } = await supabaseClient
                    .from('questions')
                    .select('count', { count: 'exact', head: true });
                
                clearTimeout(timeout);
                
                if (error && error.code !== 'PGRST116') { // PGRST116 = table doesn't exist yet
                    throw error;
                }
                
                isConnected = true;
                updateConnectionStatus(true);
                loadQuestionsFromSupabase();
            } catch (error) {
                clearTimeout(timeout);
                console.error('Connection test failed:', error);
                isConnected = false;
                updateConnectionStatus(false);
                document.getElementById('loadingOverlay').style.display = 'none';
                alert('Failed to connect to database. Error: ' + error.message);
            }
        }

        function updateConnectionStatus(connected) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            if (connected) {
                statusDot.classList.add('connected');
                statusText.textContent = 'Connected';
            } else {
                statusDot.classList.remove('connected');
                statusText.textContent = 'Disconnected';
            }
        }

        // ============================================
        // DATA MANAGEMENT
        // ============================================
        let questionBank = [];
        let currentQuiz = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];

        async function loadQuestionsFromSupabase() {
            try {
                console.log('Loading questions from Supabase...');
                const { data, error } = await supabaseClient
                    .from('questions')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(1000); // Limit to 1000 most recent questions for faster loading
                
                if (error) throw error;
                
                console.log('Questions loaded:', data?.length || 0);
                questionBank = data || [];
                displayQuestions();
                updateQuestionCount();
                buildPrelimSchoolFilters(); // Build school filters
                document.getElementById('loadingOverlay').style.display = 'none';
            } catch (error) {
                console.error('Error loading questions:', error);
                alert('Error loading questions: ' + error.message);
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        function buildPrelimSchoolFilters() {
            // Get unique school-year combinations from Prelim questions
            const prelimQuestions = questionBank.filter(q => q.source === 'Prelim' && q.school && q.source_year);
            
            // Group by year, then by school
            const schoolsByYear = {};
            prelimQuestions.forEach(q => {
                const year = q.source_year;
                const school = q.school;
                
                if (!schoolsByYear[year]) {
                    schoolsByYear[year] = new Set();
                }
                schoolsByYear[year].add(school);
            });
            
            // Build HTML
            const container = document.getElementById('prelimSchoolsContainer');
            
            if (Object.keys(schoolsByYear).length === 0) {
                container.innerHTML = '<div style="opacity: 0.7; font-size: 0.9rem;">No Prelim questions available yet</div>';
                return;
            }
            
            // Sort years descending
            const years = Object.keys(schoolsByYear).map(Number).sort((a, b) => b - a);
            
            let html = '';
            years.forEach(year => {
                const schools = Array.from(schoolsByYear[year]).sort();
                
                html += `
                    <div style="margin-bottom: 1rem;">
                        <div style="font-weight: 600; color: var(--accent); margin-bottom: 0.5rem; font-size: 0.95rem;">${year}</div>
                        <div class="checkbox-group" style="margin-left: 1rem;">
                `;
                
                schools.forEach(school => {
                    html += `
                        <label class="checkbox-label">
                            <input type="checkbox" class="source-checkbox" data-source="Prelim" data-year="${year}" data-school="${escapeHtml(school)}">
                            <span>${escapeHtml(school)}</span>
                        </label>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        async function addQuestionToSupabase(question) {
            if (!isConnected) {
                alert('Not connected to database. Please check your connection.');
                return;
            }
            
            try {
                const { data, error } = await supabaseClient
                    .from('questions')
                    .insert([{
                        text: question.text,
                        topic: question.topic,
                        difficulty: question.difficulty,
                        options: question.options,
                        correct_answer: question.correctAnswer,
                        explanation: question.explanation,
                        video_url: question.videoUrl,
                        source: question.source,
                        source_year: question.sourceYear,
                        school: question.school,
                        image_url: question.imageUrl
                    }])
                    .select();
                
                if (error) throw error;
                
                alert('Question added successfully!');
                document.getElementById('questionForm').reset();
                document.getElementById('yearGroup').style.display = 'none';
                document.getElementById('schoolGroup').style.display = 'none';
                document.getElementById('imagePreview').style.display = 'none';
                loadQuestionsFromSupabase();
            } catch (error) {
                console.error('Error adding question:', error);
                alert('Error adding question to database: ' + error.message);
            }
        }

        async function deleteQuestionFromSupabase(id) {
            if (!isConnected) {
                alert('Not connected to database. Please check your connection.');
                return;
            }
            
            if (confirm('Are you sure you want to delete this question?')) {
                try {
                    const { error } = await supabaseClient
                        .from('questions')
                        .delete()
                        .eq('id', id);
                    
                    if (error) throw error;
                    
                    alert('Question deleted successfully!');
                    loadQuestionsFromSupabase();
                } catch (error) {
                    console.error('Error deleting question:', error);
                    alert('Error deleting question from database.');
                }
            }
        }

        // ============================================
        // FORM HANDLING
        // ============================================
        
        function previewQuestion() {
            // Get form values
            const questionText = document.getElementById('questionText').value.trim();
            const topic = document.getElementById('questionTopic').value;
            const difficulty = document.getElementById('questionDifficulty').value;
            const optionsText = document.getElementById('questionOptions').value.trim();
            const correctAnswer = document.getElementById('correctAnswer').value;
            const explanation = document.getElementById('questionExplanation').value.trim();
            const videoUrl = document.getElementById('videoUrl').value.trim();
            const source = document.getElementById('questionSource').value;
            const year = document.getElementById('questionYear').value;
            const school = document.getElementById('questionSchool').value.trim();
            const imageFile = document.getElementById('questionImage').files[0];
            
            // Validate required fields
            if (!questionText) {
                alert('Please enter a question text');
                return;
            }
            if (!topic) {
                alert('Please select a topic');
                return;
            }
            if (!difficulty) {
                alert('Please select a difficulty');
                return;
            }
            if (!optionsText) {
                alert('Please enter options');
                return;
            }
            if (!correctAnswer) {
                alert('Please select the correct answer');
                return;
            }
            
            // Parse options
            const options = optionsText.split('\n').filter(opt => opt.trim() !== '');
            if (options.length < 2) {
                alert('Please provide at least 2 options');
                return;
            }
            
            // Build source tag
            let sourceTag = '';
            if (source) {
                let sourceText = source;
                if (year) sourceText += ` ${year}`;
                if (school && source === 'Prelim') sourceText += ` - ${school}`;
                sourceTag = `<span class="tag" style="background: var(--secondary); color: var(--white);">${escapeHtml(sourceText)}</span>`;
            }
            
            // Build preview HTML - don't escape question text so LaTeX can render
            let previewHTML = `
                <div class="question-meta" style="margin-bottom: 1rem;">
                    <div class="tag-container">
                        <span class="tag tag-topic">${escapeHtml(topic)}</span>
                        <span class="tag tag-difficulty ${difficulty.toLowerCase()}">${difficulty}</span>
                        ${sourceTag}
                    </div>
                </div>
                
                <div class="quiz-question-text" style="font-size: 1.3rem; line-height: 1.8; margin-bottom: 2rem;">
                    ${questionText}
                </div>
            `;
            
            // Add image preview if file selected
            if (imageFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageHTML = `
                        <div style="margin: 1.5rem 0; text-align: center;">
                            <img src="${e.target.result}" style="max-width: 100%; max-height: 400px; border-radius: 12px; border: 2px solid var(--primary); box-shadow: var(--shadow-md);">
                        </div>
                    `;
                    document.getElementById('previewContent').insertAdjacentHTML('beforeend', imageHTML);
                };
                reader.readAsDataURL(imageFile);
            }
            
            // Add options
            previewHTML += '<div class="options-container" style="display: flex; flex-direction: column; gap: 1rem;">';
            options.forEach((option, index) => {
                const letter = String.fromCharCode(65 + index);
                const isCorrect = letter === correctAnswer;
                previewHTML += `
                    <div class="option ${isCorrect ? 'correct' : ''}" style="pointer-events: none;">
                        <div class="option-letter">${letter}</div>
                        <div class="option-text">${escapeHtml(option)}</div>
                        ${isCorrect ? '<span style="margin-left: auto; color: var(--success);">‚úì Correct Answer</span>' : ''}
                    </div>
                `;
            });
            previewHTML += '</div>';
            
            // Add explanation if provided
            if (explanation) {
                previewHTML += `
                    <div style="margin-top: 2rem; padding: 1rem; background: rgba(10, 14, 39, 0.8); border-radius: 8px; border-left: 3px solid var(--accent);">
                        <strong style="color: var(--accent);">Explanation:</strong><br>
                        <div style="margin-top: 0.5rem;">${explanation}</div>
                    </div>
                `;
            }
            
            // Add video if provided
            if (videoUrl) {
                let embedUrl = videoUrl;
                if (embedUrl.includes('youtube.com/watch')) {
                    const videoId = embedUrl.split('v=')[1]?.split('&')[0];
                    embedUrl = `https://www.youtube.com/embed/${videoId}`;
                } else if (embedUrl.includes('youtu.be')) {
                    const videoId = embedUrl.split('youtu.be/')[1]?.split('?')[0];
                    embedUrl = `https://www.youtube.com/embed/${videoId}`;
                }
                
                previewHTML += `
                    <div style="margin-top: 2rem;">
                        <strong style="color: var(--primary);">Video Explanation:</strong>
                        <div style="margin-top: 0.5rem; border-radius: 8px; overflow: hidden;">
                            <iframe width="100%" height="400" src="${embedUrl}" frameborder="0" allowfullscreen></iframe>
                        </div>
                    </div>
                `;
            }
            
            // Show preview
            document.getElementById('previewContent').innerHTML = previewHTML;
            document.getElementById('previewModal').style.display = 'block';
            
            // Render math if MathJax is available
            if (window.MathJax) {
                MathJax.typesetPromise();
            }
        }
        
        function closePreview() {
            document.getElementById('previewModal').style.display = 'none';
        }
        
        function toggleYearDropdown() {
            const source = document.getElementById('questionSource').value;
            const yearGroup = document.getElementById('yearGroup');
            const schoolGroup = document.getElementById('schoolGroup');
            
            if (source === 'TYS' || source === 'Prelim') {
                yearGroup.style.display = 'block';
            } else {
                yearGroup.style.display = 'none';
                document.getElementById('questionYear').value = '';
            }
            
            // Show school field only for Prelim
            if (source === 'Prelim') {
                schoolGroup.style.display = 'block';
            } else {
                schoolGroup.style.display = 'none';
                document.getElementById('questionSchool').value = '';
            }
        }
        
        document.getElementById('questionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const optionsText = document.getElementById('questionOptions').value.trim();
            const options = optionsText.split('\n').filter(opt => opt.trim() !== '');
            
            if (options.length < 2) {
                alert('Please provide at least 2 options.');
                return;
            }
            
            const source = document.getElementById('questionSource').value;
            const year = document.getElementById('questionYear').value;
            const school = document.getElementById('questionSchool').value.trim();
            
            // Validate year if source is TYS or Prelim
            if ((source === 'TYS' || source === 'Prelim') && !year) {
                alert('Please select a year for ' + source);
                return;
            }
            
            // Validate school if source is Prelim
            if (source === 'Prelim' && !school) {
                alert('School name is required for Prelim questions');
                return;
            }
            
            // Handle image upload
            let imageUrl = null;
            const imageFile = document.getElementById('questionImage').files[0];
            
            if (imageFile) {
                try {
                    // Show uploading message
                    const submitBtn = this.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Uploading image...';
                    
                    // Upload to Supabase Storage
                    const fileExt = imageFile.name.split('.').pop();
                    const fileName = `${Date.now()}_${Math.random().toString(36).substring(7)}.${fileExt}`;
                    const filePath = `question-images/${fileName}`;
                    
                    const { data: uploadData, error: uploadError } = await supabaseClient.storage
                        .from('questions')
                        .upload(filePath, imageFile);
                    
                    if (uploadError) throw uploadError;
                    
                    // Get public URL
                    const { data: urlData } = supabaseClient.storage
                        .from('questions')
                        .getPublicUrl(filePath);
                    
                    imageUrl = urlData.publicUrl;
                    
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                } catch (error) {
                    console.error('Error uploading image:', error);
                    alert('Error uploading image: ' + error.message + '\n\nPlease make sure the "questions" storage bucket exists in Supabase.');
                    return;
                }
            }
            
            const question = {
                text: document.getElementById('questionText').value.trim(),
                topic: document.getElementById('questionTopic').value,
                difficulty: document.getElementById('questionDifficulty').value,
                options: options,
                correctAnswer: document.getElementById('correctAnswer').value,
                explanation: document.getElementById('questionExplanation').value.trim(),
                videoUrl: document.getElementById('videoUrl').value.trim(),
                source: source || null,
                sourceYear: year ? parseInt(year) : null,
                school: school || null,
                imageUrl: imageUrl
            };
            
            addQuestionToSupabase(question);
        });

        // Filter handlers
        document.getElementById('filterTopic').addEventListener('change', displayQuestions);
        document.getElementById('filterDifficulty').addEventListener('change', displayQuestions);
        document.getElementById('filterSource').addEventListener('change', displayQuestions);

        // ============================================
        // DISPLAY FUNCTIONS
        // ============================================
        function displayQuestions() {
            const filterTopic = document.getElementById('filterTopic').value;
            const filterDifficulty = document.getElementById('filterDifficulty').value;
            const filterSource = document.getElementById('filterSource').value;
            
            let filtered = questionBank.filter(q => {
                const topicMatch = !filterTopic || q.topic === filterTopic;
                const difficultyMatch = !filterDifficulty || q.difficulty === filterDifficulty;
                const sourceMatch = !filterSource || q.source === filterSource;
                return topicMatch && difficultyMatch && sourceMatch;
            });
            
            const questionList = document.getElementById('questionList');
            
            if (filtered.length === 0) {
                questionList.innerHTML = `
                    <div class="empty-state">
                        <h3>No questions found</h3>
                        <p>Try adjusting your filters or add new questions.</p>
                    </div>
                `;
                return;
            }
            
            questionList.innerHTML = filtered.map(question => {
                // Build source tag if available
                let sourceTag = '';
                if (question.source) {
                    let sourceText = question.source;
                    if (question.source_year) {
                        sourceText += ` ${question.source_year}`;
                    }
                    if (question.school && question.source === 'Prelim') {
                        sourceText += ` - ${question.school}`;
                    }
                    sourceTag = `<span class="tag" style="background: var(--secondary); color: var(--white);">${sourceText}</span>`;
                }
                
                return `
                <div class="question-item">
                    <div class="question-header">
                        <div class="tag-container">
                            <span class="tag tag-topic">${escapeHtml(question.topic)}</span>
                            <span class="tag tag-difficulty ${question.difficulty.toLowerCase()}">${question.difficulty}</span>
                            ${sourceTag}
                        </div>
                        <div class="question-actions">
                            <button class="btn btn-danger" style="padding: 0.5rem 1rem;" onclick="deleteQuestionFromSupabase(${question.id})">Delete</button>
                        </div>
                    </div>
                    <div class="question-text">${escapeHtml(question.text)}</div>
                    ${question.image_url ? `<div style="margin-top: 1rem;"><img src="${escapeHtml(question.image_url)}" style="max-width: 100%; max-height: 300px; border-radius: 8px; border: 1px solid rgba(0, 217, 255, 0.3);"></div>` : ''}
                    <ul class="options-list">
                        ${question.options.map((opt, idx) => `
                            <li class="${String.fromCharCode(65 + idx) === question.correct_answer ? 'correct' : ''}">
                                <strong>${String.fromCharCode(65 + idx)}:</strong> ${escapeHtml(opt)}
                                ${String.fromCharCode(65 + idx) === question.correct_answer ? '<span style="color: var(--success); margin-left: auto;">‚úì Correct</span>' : ''}
                            </li>
                        `).join('')}
                    </ul>
                    ${question.explanation ? `<div style="margin-top: 1rem; padding: 0.75rem; background: rgba(0, 0, 0, 0.3); border-radius: 6px;"><strong>Explanation:</strong> ${escapeHtml(question.explanation)}</div>` : ''}
                    ${question.video_url ? `<div style="margin-top: 1rem;"><a href="${escapeHtml(question.video_url)}" target="_blank" style="color: var(--primary);">üìπ Video Explanation</a></div>` : ''}
                </div>
            `}).join('');
            
            // Render math
            if (window.MathJax) {
                MathJax.typesetPromise();
            }
        }

        function updateQuestionCount() {
            document.getElementById('questionCount').textContent = questionBank.length;
        }

        // ============================================
        // VIEW MANAGEMENT
        // ============================================
        function showView(viewName) {
            const views = document.querySelectorAll('.view');
            views.forEach(view => view.classList.remove('active'));
            
            const targetView = document.getElementById(viewName + 'View');
            if (targetView) {
                targetView.classList.add('active');
            }
            
            updateNavigation();
            
            setTimeout(() => {
                if (window.MathJax) {
                    MathJax.typesetPromise();
                }
            }, 100);
        }

        function updateNavigation() {
            const navButtons = document.getElementById('navButtons');
            const activeView = document.querySelector('.view.active');
            const viewId = activeView ? activeView.id : '';
            
            let buttons = '';
            
            if (viewId === 'welcomeView') {
                buttons = '';
            } else if (viewId === 'adminView') {
                buttons = '<button class="btn btn-secondary" onclick="showView(\'welcome\')">Home</button>';
            } else if (viewId === 'studentView') {
                buttons = '<button class="btn btn-secondary" onclick="showView(\'welcome\')">Home</button>';
            } else if (viewId === 'quizView') {
                buttons = '<button class="btn btn-danger" onclick="confirmExitQuiz()">Exit Quiz</button>';
            } else if (viewId === 'resultsView') {
                buttons = '<button class="btn btn-secondary" onclick="showView(\'welcome\')">Home</button>';
            }
            
            navButtons.innerHTML = buttons;
        }

        function confirmExitQuiz() {
            if (confirm('Are you sure you want to exit the quiz? Your progress will be lost.')) {
                showView('student');
            }
        }

        // ============================================
        // QUIZ FUNCTIONALITY
        // ============================================
        
        function toggleAllTopics() {
            const selectAll = document.getElementById('selectAllTopics');
            const topicCheckboxes = document.querySelectorAll('.topic-checkbox');
            
            topicCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }
        
        function startQuiz() {
            const selectedTopics = Array.from(document.querySelectorAll('.topic-checkbox:checked'))
                .map(cb => cb.value);
            const selectedDifficulties = Array.from(document.querySelectorAll('#difficultyCheckboxes input:checked'))
                .map(cb => cb.value);
            const selectedSources = Array.from(document.querySelectorAll('.source-checkbox:checked'))
                .map(cb => ({
                    source: cb.getAttribute('data-source'),
                    year: cb.getAttribute('data-year') ? parseInt(cb.getAttribute('data-year')) : null,
                    school: cb.getAttribute('data-school') || null
                }));
            const numQuestions = parseInt(document.getElementById('numQuestions').value);
            
            if (selectedTopics.length === 0) {
                alert('Please select at least one topic.');
                return;
            }
            
            if (selectedDifficulties.length === 0) {
                alert('Please select at least one difficulty level.');
                return;
            }
            
            // Filter questions
            let availableQuestions = questionBank.filter(q => {
                const topicMatch = selectedTopics.includes(q.topic);
                const difficultyMatch = selectedDifficulties.includes(q.difficulty);
                
                // Source filtering logic
                let sourceMatch = true;
                if (selectedSources.length > 0) {
                    sourceMatch = selectedSources.some(s => {
                        // If no source specified in question, don't match
                        if (!q.source) return false;
                        
                        // Check source match
                        if (s.source !== q.source) return false;
                        
                        // If year is specified in filter, check year match
                        if (s.year !== null && q.source_year !== s.year) return false;
                        
                        // If school is specified in filter (Prelim), check school match
                        if (s.school !== null && q.school !== s.school) return false;
                        
                        return true;
                    });
                }
                
                return topicMatch && difficultyMatch && sourceMatch;
            });
            
            if (availableQuestions.length === 0) {
                alert('No questions available with the selected criteria.');
                return;
            }
            
            if (availableQuestions.length < numQuestions) {
                alert(`Only ${availableQuestions.length} questions available. Starting quiz with ${availableQuestions.length} questions.`);
            }
            
            // Shuffle and select questions
            currentQuiz = shuffleArray(availableQuestions).slice(0, Math.min(numQuestions, availableQuestions.length));
            currentQuestionIndex = 0;
            userAnswers = new Array(currentQuiz.length).fill(null);
            
            // Reset navigation button states
            document.getElementById('prevBtn').onclick = previousQuestion;
            document.getElementById('nextBtn').onclick = nextQuestion;
            document.getElementById('submitBtn').onclick = submitQuiz;
            document.getElementById('nextBtn').textContent = 'Next Question';
            document.getElementById('submitBtn').textContent = 'Submit Quiz';
            
            showView('quiz');
            displayQuizQuestion();
        }

        function displayQuizQuestion() {
            const question = currentQuiz[currentQuestionIndex];
            
            // Debug logging
            console.log('Current question:', question);
            console.log('Options:', question.options);
            console.log('Options type:', typeof question.options);
            console.log('Is array?:', Array.isArray(question.options));
            
            // Update progress
            document.getElementById('currentQuestion').textContent = `Question ${currentQuestionIndex + 1}`;
            document.getElementById('totalQuestions').textContent = `of ${currentQuiz.length}`;
            document.getElementById('progressFill').style.width = `${((currentQuestionIndex + 1) / currentQuiz.length) * 100}%`;
            
            // Update tags
            let sourceTag = '';
            if (question.source) {
                let sourceText = question.source;
                if (question.source_year) {
                    sourceText += ` ${question.source_year}`;
                }
                if (question.school && question.source === 'Prelim') {
                    sourceText += ` - ${question.school}`;
                }
                sourceTag = `<span class="tag" style="background: var(--secondary); color: var(--white);">${sourceText}</span>`;
            }
            
            document.getElementById('quizQuestionTags').innerHTML = `
                <span class="tag tag-topic">${escapeHtml(question.topic)}</span>
                <span class="tag tag-difficulty ${question.difficulty.toLowerCase()}">${question.difficulty}</span>
                ${sourceTag}
            `;
            
            // Update question text (use innerHTML to allow LaTeX rendering)
            document.getElementById('quizQuestionText').innerHTML = escapeHtml(question.text);
            
            // Display image if available
            const quizQuestion = document.querySelector('.quiz-question');
            let existingImage = quizQuestion.querySelector('.question-image-container');
            if (existingImage) existingImage.remove();
            
            if (question.image_url) {
                const imageContainer = document.createElement('div');
                imageContainer.className = 'question-image-container';
                imageContainer.style.cssText = 'margin: 1.5rem 0; text-align: center;';
                imageContainer.innerHTML = `<img src="${escapeHtml(question.image_url)}" style="max-width: 100%; max-height: 400px; border-radius: 12px; border: 2px solid var(--primary); box-shadow: var(--shadow-md);">`;
                document.getElementById('quizQuestionText').after(imageContainer);
            }
            
            // Update options - with safety check
            const optionsContainer = document.getElementById('quizOptions');
            
            // Make sure options is an array
            const optionsArray = Array.isArray(question.options) ? question.options : [];
            
            if (optionsArray.length === 0) {
                console.error('No options found for question!');
                optionsContainer.innerHTML = '<div style="color: red; padding: 1rem;">Error: No options available for this question. Please check the database.</div>';
                return;
            }
            
            optionsContainer.innerHTML = optionsArray.map((option, index) => {
                const letter = String.fromCharCode(65 + index);
                const isSelected = userAnswers[currentQuestionIndex] === letter;
                
                return `
                    <div class="option ${isSelected ? 'selected' : ''}" onclick="selectOption('${letter}')">
                        <div class="option-letter">${letter}</div>
                        <div class="option-text">${escapeHtml(option)}</div>
                    </div>
                `;
            }).join('');
            
            // Hide video and explanation in quiz mode
            document.getElementById('videoContainer').style.display = 'none';
            document.getElementById('explanationContainer').style.display = 'none';
            
            // Update navigation buttons
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            document.getElementById('nextBtn').style.display = currentQuestionIndex < currentQuiz.length - 1 ? 'block' : 'none';
            document.getElementById('submitBtn').style.display = currentQuestionIndex === currentQuiz.length - 1 ? 'block' : 'none';
            
            // Render math
            if (window.MathJax) {
                MathJax.typesetPromise();
            }
        }

        function selectOption(letter) {
            userAnswers[currentQuestionIndex] = letter;
            displayQuizQuestion();
        }

        function nextQuestion() {
            if (currentQuestionIndex < currentQuiz.length - 1) {
                currentQuestionIndex++;
                displayQuizQuestion();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuizQuestion();
            }
        }

        function submitQuiz() {
            const unanswered = userAnswers.filter(a => a === null).length;
            if (unanswered > 0) {
                if (!confirm(`You have ${unanswered} unanswered question(s). Submit anyway?`)) {
                    return;
                }
            }
            
            // Calculate score
            let correct = 0;
            currentQuiz.forEach((question, index) => {
                if (userAnswers[index] === question.correct_answer) {
                    correct++;
                }
            });
            
            const percentage = Math.round((correct / currentQuiz.length) * 100);
            
            // Display results
            document.getElementById('finalScore').textContent = `${percentage}%`;
            document.getElementById('resultsMessage').textContent = 
                percentage >= 90 ? 'Outstanding! You\'re a chemistry master!' :
                percentage >= 70 ? 'Great job! Keep up the good work!' :
                percentage >= 50 ? 'Good effort! Review the topics and try again.' :
                'Keep practicing! You\'ll improve with time.';
            
            // Breakdown by topic and difficulty
            const breakdown = {};
            currentQuiz.forEach((question, index) => {
                const key = `${question.topic} - ${question.difficulty}`;
                if (!breakdown[key]) {
                    breakdown[key] = { correct: 0, total: 0 };
                }
                breakdown[key].total++;
                if (userAnswers[index] === question.correct_answer) {
                    breakdown[key].correct++;
                }
            });
            
            let breakdownHtml = '<h3 style="margin-bottom: 1rem;">Performance Breakdown</h3>';
            for (const [key, stats] of Object.entries(breakdown)) {
                const pct = Math.round((stats.correct / stats.total) * 100);
                breakdownHtml += `
                    <div style="background: rgba(10, 14, 39, 0.6); padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; display: flex; justify-content: space-between;">
                        <span>${escapeHtml(key)}</span>
                        <span style="color: var(--accent);">${stats.correct}/${stats.total} (${pct}%)</span>
                    </div>
                `;
            }
            
            document.getElementById('resultsBreakdown').innerHTML = breakdownHtml;
            
            showView('results');
        }

        function reviewQuiz() {
            currentQuestionIndex = 0;
            showView('quiz');
            displayReviewQuestion();
        }

        function displayReviewQuestion() {
            const question = currentQuiz[currentQuestionIndex];
            const userAnswer = userAnswers[currentQuestionIndex];
            const isCorrect = userAnswer === question.correct_answer;
            
            // Update progress
            document.getElementById('currentQuestion').textContent = `Question ${currentQuestionIndex + 1}`;
            document.getElementById('totalQuestions').textContent = `of ${currentQuiz.length}`;
            document.getElementById('progressFill').style.width = `${((currentQuestionIndex + 1) / currentQuiz.length) * 100}%`;
            
            // Update tags
            let sourceTag = '';
            if (question.source) {
                let sourceText = question.source;
                if (question.source_year) {
                    sourceText += ` ${question.source_year}`;
                }
                if (question.school && question.source === 'Prelim') {
                    sourceText += ` - ${question.school}`;
                }
                sourceTag = `<span class="tag" style="background: var(--secondary); color: var(--white);">${sourceText}</span>`;
            }
            
            document.getElementById('quizQuestionTags').innerHTML = `
                <span class="tag tag-topic">${escapeHtml(question.topic)}</span>
                <span class="tag tag-difficulty ${question.difficulty.toLowerCase()}">${question.difficulty}</span>
                ${sourceTag}
                <span class="tag" style="background: ${isCorrect ? 'var(--success)' : 'var(--danger)'}; color: ${isCorrect ? 'var(--dark)' : 'var(--white)'};">
                    ${isCorrect ? '‚úì Correct' : '‚úó Incorrect'}
                </span>
            `;
            
            // Update question text (use innerHTML for LaTeX)
            document.getElementById('quizQuestionText').innerHTML = escapeHtml(question.text);
            
            // Display image if available
            const quizQuestion = document.querySelector('.quiz-question');
            let existingImage = quizQuestion.querySelector('.question-image-container');
            if (existingImage) existingImage.remove();
            
            if (question.image_url) {
                const imageContainer = document.createElement('div');
                imageContainer.className = 'question-image-container';
                imageContainer.style.cssText = 'margin: 1.5rem 0; text-align: center;';
                imageContainer.innerHTML = `<img src="${escapeHtml(question.image_url)}" style="max-width: 100%; max-height: 400px; border-radius: 12px; border: 2px solid var(--primary); box-shadow: var(--shadow-md);">`;
                document.getElementById('quizQuestionText').after(imageContainer);
            }
            
            // Update options with correct/incorrect indicators
            const optionsContainer = document.getElementById('quizOptions');
            optionsContainer.innerHTML = question.options.map((option, index) => {
                const letter = String.fromCharCode(65 + index);
                const isUserAnswer = userAnswer === letter;
                const isCorrectAnswer = question.correct_answer === letter;
                
                let className = 'option';
                if (isCorrectAnswer) className += ' correct';
                else if (isUserAnswer && !isCorrect) className += ' incorrect';
                
                return `
                    <div class="${className}">
                        <div class="option-letter">${letter}</div>
                        <div class="option-text">${escapeHtml(option)}</div>
                        ${isUserAnswer ? '<span style="margin-left: auto;">Your answer</span>' : ''}
                        ${isCorrectAnswer ? '<span style="margin-left: auto; color: var(--success);">‚úì Correct</span>' : ''}
                    </div>
                `;
            }).join('');
            
            // Show explanation
            if (question.explanation) {
                document.getElementById('explanationContainer').style.display = 'block';
                document.getElementById('quizExplanation').innerHTML = escapeHtml(question.explanation);
            }
            
            // Show video if available
            if (question.video_url) {
                document.getElementById('videoContainer').style.display = 'block';
                const videoPreview = document.getElementById('quizVideoPreview');
                
                let embedUrl = question.video_url;
                if (embedUrl.includes('youtube.com/watch')) {
                    const videoId = embedUrl.split('v=')[1]?.split('&')[0];
                    embedUrl = `https://www.youtube.com/embed/${videoId}`;
                } else if (embedUrl.includes('youtu.be')) {
                    const videoId = embedUrl.split('youtu.be/')[1]?.split('?')[0];
                    embedUrl = `https://www.youtube.com/embed/${videoId}`;
                }
                
                videoPreview.innerHTML = `<iframe width="100%" height="400" src="${embedUrl}" frameborder="0" allowfullscreen></iframe>`;
            }
            
            // Update navigation
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            document.getElementById('prevBtn').onclick = () => {
                if (currentQuestionIndex > 0) {
                    currentQuestionIndex--;
                    displayReviewQuestion();
                }
            };
            
            if (currentQuestionIndex < currentQuiz.length - 1) {
                document.getElementById('nextBtn').style.display = 'block';
                document.getElementById('nextBtn').textContent = 'Next Question';
                document.getElementById('nextBtn').onclick = () => {
                    currentQuestionIndex++;
                    displayReviewQuestion();
                };
                document.getElementById('submitBtn').style.display = 'none';
            } else {
                document.getElementById('nextBtn').style.display = 'none';
                document.getElementById('submitBtn').style.display = 'block';
                document.getElementById('submitBtn').textContent = 'Back to Results';
                document.getElementById('submitBtn').onclick = () => showView('results');
            }
            
            // Render math
            if (window.MathJax) {
                MathJax.typesetPromise();
            }
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            updateNavigation();
        });
    </script>
</body>
</html>
